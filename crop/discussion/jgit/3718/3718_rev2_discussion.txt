DESCRIPTION

Fix reading of ref names containing characters that sort before /

A set of ref names like ('a/b' and 'a+b') would cause the RefDirectory
to think that the set of refs have changed because it traversed the
'a' directory in the subtree before looking at 'a+b', but it then
compared with the know refs which are sorted with 'a+b' first.

Fix this by traversing the refs tree in another order. Treat a directory
as if they ends with a '/' before deciding on the order to traverse
the refs tree.

Bug: 348834
Change-Id: I23377f8df00c7252bf27dbcfba5da193c5403917
Signed-off-by: Juliet Cantu xxx@xxx.xxx


COMMENTS

author: Juliet Cantu
date: 2011-06-12 22:43:41.000000000

Uploaded patch set 2.

-------------------------------------
author: Brenden Conley
date: 2011-06-12 22:44:15.000000000

Patch Set 2:

Build Started https://hudson.eclipse.org/sandbox/job/jgit.gerrit/575/ 

-------------------------------------
author: Brenden Conley
date: 2011-06-12 22:47:44.000000000

Patch Set 2: Build Successful

Build Successful 
 
https://hudson.eclipse.org/sandbox/job/jgit.gerrit/575/ : SUCCESS

-------------------------------------
author: Yoselin Hanna
date: 2011-06-24 22:41:07.000000000

Patch Set 2: I would prefer that you didn't submit this

(1 inline comment)



Line:398, org.eclipse.jgit/src/org/eclipse/jgit/storage/file/RefDirectory.java -> Instead of all of these HashMap operations, why not:

  for (int i = 0; i < entries.length) {
    if (new File(dir, entries[i])).isDirectory())
      entries[i] += "/";
  }
  Arrays.sort(entries);

Its fewer object allocations. We don't have the hash operations. We can still use the natural comparator for Arrays.sort().

And below in the scanTree routine, we already need name + "/" for a directory anyway. And we can decide to enter scanTree or scanOne using the suffix:

  for (String name : entries) {
    if (name.charAt(name.length() - 1) == '/')
      scanTree(prefix + name, new File(dir, name);
    else
      scanOne(prefix + name);
  }

-------------------------------------
author: Juliet Cantu
date: 2011-07-22 09:52:40.000000000

Patch Set 2: (1 inline comment)



Line:398, org.eclipse.jgit/src/org/eclipse/jgit/storage/file/RefDirectory.java -> Done

-------------------------------------
