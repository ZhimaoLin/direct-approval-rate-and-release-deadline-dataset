DESCRIPTION

Fix concurrent creation of fan-out object directories

If multiple threads attempted to insert loose objects into the same new
fan-out directory, the creation of that directory was subject to a race
condition that could lead to an unnecessary IOException being thrown -
because an inserter could not 'create' a directory that had just been
generated by a different thread. All we require is that the directory
does indeed *exist*, so not being able to _create_ it is not actually a
fatal problem. Setting 'skipExisting' to 'true' on the call to mkdir()
fixes the issue.

I found this issue as a real world occurrence while working on The BFG
Repo Cleaner (https://github.com/rtyley/bfg-repo-cleaner), a tool which
concurrently performs a lot of object creation.

In order to demonstrate the problem here I've added a small test case
which reliably reproduces the issue on the few different hardware
systems I've tried. The error thrown when the race-condition arises is
this:

java.io.IOException: Creating directory /home/Jacob Stuart/repo.git/objects/e6 failed
at org.eclipse.jgit.util.FileUtils.mkdir(FileUtils.java:182)
at org.eclipse.jgit.storage.file.ObjectDirectory.insertUnpackedObject(ObjectDirectory.java:590)
at org.eclipse.jgit.storage.file.ObjectDirectoryInserter.insertOneObject(ObjectDirectoryInserter.java:113)
at org.eclipse.jgit.storage.file.ObjectDirectoryInserter.insert(ObjectDirectoryInserter.java:91)
at org.eclipse.jgit.lib.ObjectInserter.insert(ObjectInserter.java:329)

Change-Id: I88eac49bc600c56ba9ad290e6133d8a7113125ab


COMMENTS

author: Brenden Conley
date: 2012-12-25 09:11:11.000000000

Patch Set 1:

Build Started https://hudson.eclipse.org/sandbox/job/jgit.gerrit/2604/ 

-------------------------------------
author: Brenden Conley
date: 2012-12-25 09:16:19.000000000

Patch Set 1: Verified

Build Successful 

https://hudson.eclipse.org/sandbox/job/jgit.gerrit/2604/ : SUCCESS

-------------------------------------
author: Juliet Cantu
date: 2013-01-13 00:29:07.000000000

Patch Set 1: Looks good to me, approved; Unclean IP, do not check in

Please assert your rights. See http://wiki.eclipse.org/Development_Resources/Handling_Git_Contributions#Gerrit

-------------------------------------
author: Kendrick Carrillo
date: 2013-01-13 18:43:47.000000000

Patch Set 1: Looks good to me, but someone else must approve

Thanks Robin - I hope it's ok to add the rights assertion here.

With respect to this submission:

1. I have authored 100% of the content I'm contributing
2. I have the rights to donate the content to Eclipse
3. I contribute the content under the EPL

-------------------------------------
author: Juliet Cantu
date: 2013-01-13 23:59:45.000000000

Patch Set 1: IP review completed



-------------------------------------
author: Gerrit Code Review
date: 2013-01-13 23:59:53.000000000

Your change could not be merged due to a path conflict.

Please merge (or rebase) the change locally and upload the resolution for review.

-------------------------------------
author: Juliet Cantu
date: 2013-01-13 23:59:59.000000000

Patch Set 1: Rebased

-------------------------------------
