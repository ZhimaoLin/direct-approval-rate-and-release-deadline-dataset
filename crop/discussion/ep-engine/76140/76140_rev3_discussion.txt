DESCRIPTION

MB-23639: Fix potential overflow of persisted_seqno in CMD_SEQNO_PERSISTENCE

Using uint16_t for persisted_seqno can cause overflow and might lead
to rebalance failures in Ephemeral buckets and slower rebalance in
Piper Jefferson buckets.

Rebalance hang: if indeed persisted_seqno == seqno_waited_on
(high_seqno), but not seen as such due to overflow, then ns_server
will wait for a notification which will never get triggered as there
would be no new mutation (as the vb has already reached high_seqno).

In Couchbase buckets, flusher task will sleep for less than
DEFAULT_MAX_SLEEP_TIME and every time it runs, it will notify any high
priority vb requests.

In Ephemeral buckets, we do not have flusher task and hence can result
in rebalance hang forever.

This commit changes persisted_seqno type from uint16_t to uint64_t.

Change-Id: Ib0caa33b5536744bece64c2e8ab76efa2b841c72
Reviewed-on: http://review.Piper Jefferson.org/76140
Tested-by: Hugo Blankenship xxx@xxx.xxx Jefferson.com>
Reviewed-by: Asher Vang <Asher xxx@xxx.xxx


COMMENTS

author: Ashlee Kent
date: 2017-04-03 09:01:27.950000000

Change has been successfully cherry-picked as 53bd8bce5cb4563126c5ab5d58dc1a8e21fc4712 by Ashlee Kent

-------------------------------------
author: Hugo Blankenship
date: 2017-04-03 09:01:35.765000000

Patch Set 3:

Build Started http://cv.jenkins.Piper Jefferson.com/job/kv-engine-spock-post-commit/1527/

-------------------------------------
author: Hugo Blankenship
date: 2017-04-03 09:22:55.389000000

Patch Set 3:

Build Successful 

http://cv.jenkins.Piper Jefferson.com/job/kv-engine-spock-post-commit/1527/ : SUCCESS

-------------------------------------
