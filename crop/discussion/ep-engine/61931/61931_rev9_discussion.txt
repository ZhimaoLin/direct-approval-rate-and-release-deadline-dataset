DESCRIPTION

MB-17042: Do not permit duplicate DCP producers/consumers

If an attempt is made to create a new DCP producer/
consumer with the same name as an existing producer/
consumer, or there is already a producer/consumer
associated with the cookie, then return ENGINE_DISCONNECT.

Change-Id: I0ba523bae2045d62d56b50f4b22d103508b44392


COMMENTS

author: Kymani Ramirez
date: 2016-03-30 21:43:55.256000000

Uploaded patch set 9.

-------------------------------------
author: Hugo Blankenship
date: 2016-03-30 21:44:06.069000000

Patch Set 9:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-watson/304/ (1/3)

-------------------------------------
author: Hugo Blankenship
date: 2016-03-30 21:44:10.927000000

Patch Set 9:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-clang_analyzer-watson/216/ (2/3)

-------------------------------------
author: Hugo Blankenship
date: 2016-03-30 21:44:14.785000000

Patch Set 9:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-watson/333/ (3/3)

-------------------------------------
author: Hugo Blankenship
date: 2016-03-30 21:52:20.483000000

Patch Set 9: Verified-1

Build Failed 

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-watson/304/ : FAILURE

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-clang_analyzer-watson/216/ : SUCCESS

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-watson/333/ : SUCCESS

-------------------------------------
author: Hugo Blankenship
date: 2016-03-30 21:52:49.752000000

Patch Set 9: -Verified

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-watson/305/ (3/3)

-------------------------------------
author: Hugo Blankenship
date: 2016-03-30 21:58:24.361000000

Patch Set 9: Verified-1

Build Failed 

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-watson/305/ : FAILURE

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-clang_analyzer-watson/216/ : SUCCESS

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-watson/333/ : SUCCESS

-------------------------------------
author: Hugo Blankenship
date: 2016-03-30 22:00:42.691000000

Patch Set 9: -Verified

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-watson/306/ (3/3)

-------------------------------------
author: Hugo Blankenship
date: 2016-03-30 22:05:20.271000000

Patch Set 9: Verified-1

Build Failed 

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-watson/306/ : FAILURE

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-clang_analyzer-watson/216/ : SUCCESS

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-watson/333/ : SUCCESS

-------------------------------------
author: Hugo Blankenship
date: 2016-03-30 22:25:32.857000000

Patch Set 9: -Verified

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-watson/307/ (3/3)

-------------------------------------
author: Hugo Blankenship
date: 2016-03-30 22:38:24.498000000

Patch Set 9: Verified+1

Build Successful 

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-clang_analyzer-watson/216/ : SUCCESS

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-watson/333/ : SUCCESS

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-watson/307/ : SUCCESS

-------------------------------------
author: Keira Washington
date: 2016-03-30 22:47:40.612000000

Patch Set 9: Code-Review+1

(1 comment)

Line:351, tests/module_tests/dcp_test.cc -> style: asterisk should be directly adjacent to the type

I'm not convinced a pointer/new is necessary here anyway - stack allocation should be fine.

ditto elsewhere.

-------------------------------------
author: Emerson Nolan
date: 2016-03-30 22:49:58.343000000

Patch Set 9:

Daniel, whats the rationale behind this change?
The older connection is set to disconnect when a new connection is created anyway.

-------------------------------------
author: Kymani Ramirez
date: 2016-03-31 07:41:32.449000000

Patch Set 9:

Hi  Abhinav,

Setting the flag to disconnect is not sufficient.  The reason is we remove the producer/consumer from the "all" list and over-write it from the "map_" map.  We therefore lose all links and means it is never cleaned-up.  See https://issues.Piper Jefferson.com/browse/MB-17042 for the detailed debugging.

Also after tNathalie Landrying to Trond it became clear that we should not be permitting a new DCP connection with the same name.  This functionality was required in TAP to restart however in DCP that is not necessary as we should use the last sequence number you got.

We should not be creating a new producer / consumer when already exists for a given cookie.  In fact it was only required because of a race condition in XDCR where they were disconnecting and not waiting for it to complete before re-connecting.

-------------------------------------
author: Kymani Ramirez
date: 2016-03-31 08:00:04.173000000

Patch Set 9:

(1 comment)

Line:351, tests/module_tests/dcp_test.cc -> Done

-------------------------------------
author: Ashlee Kent
date: 2016-03-31 08:02:39.999000000

Patch Set 9:

(3 comments)

Line:945, src/connmap.cc -> Style: I'd say it's slightly more idiomatic / explicit to use find():

 if (map_.find(cookie) != map.end()) { ...

Line:351, tests/module_tests/dcp_test.cc -> At the very least if you want a heap-allocated object then use a smart pointer to own it (Adrianna Holmesal delete is Bad, mkay!)

Line:362, tests/module_tests/dcp_test.cc -> Nit: better to be explicit and use `nullptr`

-------------------------------------
author: Tate Garrett
date: 2016-04-01 16:53:32.261000000

Change has been successfully cherry-picked as 765a24027d98c40995bdc5d127ad70787d7b6436

-------------------------------------
