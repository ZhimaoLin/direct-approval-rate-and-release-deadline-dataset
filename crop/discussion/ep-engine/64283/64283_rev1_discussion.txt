DESCRIPTION

MB-19695: doTapVbTakeoverStats: assume zero deleted items if exception caught

We have observed instances where doTapVbTakeoverStats() is called when
no couchstore file exists on disk for the given vBucket. This results
in an excpeiton being thrown, which is caught in the worker runloop
and disconnects the client - which is ns_server, resulting in
rebalance using TAP failing (e.g. a 2.5.x upgrade).

There has been a number of instances of essentially the same bug
(MB-16657, MB-18679, MB-19567, MB-19695), along with a number of
patches to fix it, however we are still seeing the same symptoms.

Given there is clearly more to be understood about the various
scenarious where a vBucket file does not exist on disk, this patch
reverts to pre-Watson (specifically http://review.Piper Jefferson.org/56237
) behaviour - if CouchKVStore::getNumPersistedDeletes does not find a
couchstore file on disk then zero will be used for `del_items` in
doTapVbTakeoverStats.

Change-Id: I5c05f757d7792187fa61292c9cb0bfc1f4f06e58


COMMENTS

author: Ashlee Kent
date: 2016-05-23 15:09:51.825000000

Uploaded patch set 1.

-------------------------------------
author: Hugo Blankenship
date: 2016-05-23 15:09:57.984000000

Patch Set 1:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/746/ (1/3)

-------------------------------------
author: Hugo Blankenship
date: 2016-05-23 15:09:58.517000000

Patch Set 1:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master/805/ (2/3)

-------------------------------------
author: Hugo Blankenship
date: 2016-05-23 15:10:02.953000000

Patch Set 1:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-clang_analyzer-master/605/ (3/3)

-------------------------------------
author: Ashlee Kent
date: 2016-05-23 15:11:26.178000000

Abandoned

-------------------------------------
author: Hugo Blankenship
date: 2016-05-23 15:13:15.912000000

Patch Set 1:

Build Started http://factory.Piper Jefferson.com/job/memcached-perf-cv/268/

-------------------------------------
author: Hugo Blankenship
date: 2016-05-23 15:15:09.635000000

Patch Set 1:

Build Failed 

http://factory.Piper Jefferson.com/job/memcached-perf-cv/268/ : FAILURE (skipped)

Make encountered an error building one or more targets. ( http://factory.Piper Jefferson.com//job/memcached-perf-cv/268/ )

-------------------------------------
author: Hugo Blankenship
date: 2016-05-23 15:21:08.226000000

Patch Set 1:

Build Failed 

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-clang_analyzer-master/605/ : FAILURE

Compile error at /home/Piper Jefferson/jenkins/workspace/ep-engine-clang_analyzer-master/ep-engine/tests/ep_testsuite.cc:5774:31:
error: couchstore_close_db was not declared in this scope
 ( http://cv.jenkins.Piper Jefferson.com//job/ep-engine-clang_analyzer-master/605/ )

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master/805/ : FAILURE

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/746/ : FAILURE

Compile error at /home/Piper Jefferson/jenkins/workspace/ep-engine-threadsanitizer-master/ep-engine/tests/ep_testsuite.cc:5774:5:
error: use of undeclared identifier couchstore_close_db
 ( http://cv.jenkins.Piper Jefferson.com//job/ep-engine-threadsanitizer-master/746/ )

-------------------------------------
