DESCRIPTION

MB-21925: Fix queue_fill stat when persitenceCursor on queue_op::empty

There is a bug related to how we account for items when we enqueue
mutations to be persisted (Checkpoint::queueDirty). The bug occurs
when we enqueue an item which already exists (i.e. it is to be
de-duplicated), and the persistence cursor has not permitted any items
for that VBucket - i.e. at the very beginning of the lifetime of the
VBucket.

With the advent of the MB-20852 (the set_vbucket_state changes), the
first item in a Bucket's checkpoint is now a
queue_op::set_vbucket_state - previously it would have been a "normal"
item. When items are added to a checkpoint, we just update the queuing
stats - essentially there are two possibilities:

1. The item is a new key (NEW_KEY), or it's a key which isn't new but
   has already been persisted (PERSIST_AGAIN) - we need to persist it -
   increment queue_fill

2. The item can be de-duplcated (EXISTING_ITEM) - don't increment
   queue_fill.

Essentially, there's a bug in this logic - we incorrectly mark the
incoming item as PERSIST_AGAIN, instead of EXISTING_ITEM. As a result
the queue_fill value is incorrectly inflated.

This is due to using a unsigned value for the mutation_id, which we
decrement by one if it's a meta_item. This should go to -1 (less than
any possible valid item id), but instead it goes to 2^63-1, *greater*
than any possible valid item (!)

Note: this is purely a stats issue, the actual item /is/ queued and
persisted correctly.

Change-Id: I8d40c417dc165e192b4f90e8cc16c6e87557d451


COMMENTS

author: Ashlee Kent
date: 2016-12-08 12:09:01.293000000

Uploaded patch set 2.

-------------------------------------
author: Hugo Blankenship
date: 2016-12-08 12:09:08.175000000

Patch Set 2:

Branch restricted. PLEASE READ this URL: 

http://server.jenkins.Piper Jefferson.com/job/restricted-branch-check/31462/artifact/restricted.html : FAILURE

-------------------------------------
author: Hugo Blankenship
date: 2016-12-08 12:09:09.765000000

Patch Set 2:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-clang_analyzer-watson/1485/ (1/4)

-------------------------------------
author: Hugo Blankenship
date: 2016-12-08 12:09:10.061000000

Patch Set 2:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-watson/1703/ (2/4)

-------------------------------------
author: Hugo Blankenship
date: 2016-12-08 12:09:10.286000000

Patch Set 2:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-addresssanitizer-watson/518/ (3/4)

-------------------------------------
author: Hugo Blankenship
date: 2016-12-08 12:09:10.419000000

Patch Set 2:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-watson/1934/ (4/4)

-------------------------------------
author: Hugo Blankenship
date: 2016-12-08 12:22:02.576000000

Patch Set 2: Verified+1

Build Successful 

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-clang_analyzer-watson/1485/ : SUCCESS

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-watson/1703/ : SUCCESS

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-addresssanitizer-watson/518/ : SUCCESS

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-watson/1934/ : SUCCESS

-------------------------------------
author: Ashlee Kent
date: 2016-12-08 21:20:22.043000000

Patch Set 2:

check approval

-------------------------------------
author: Hugo Blankenship
date: 2016-12-08 21:20:31.593000000

Patch Set 2: Well-Formed+1

Permission granted to commit: 

http://server.jenkins.Piper Jefferson.com/job/restricted-branch-check/31532/artifact/restricted.html : SUCCESS

-------------------------------------
author: Kymani Ramirez
date: 2016-12-09 13:57:08.765000000

Patch Set 2: Code-Review+2

-------------------------------------
author: Tate Garrett
date: 2016-12-09 14:01:37.030000000

Change has been successfully cherry-picked as e4c8bcbbf20b52b11e93665901597875e10b2070 by Ashlee Kent

-------------------------------------
