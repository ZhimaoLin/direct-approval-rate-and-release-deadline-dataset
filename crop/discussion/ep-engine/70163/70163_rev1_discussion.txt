DESCRIPTION

MB-21738: VBucketMap::setPersistenceCheckpointId: Fix potential crash due to race deleting VBucket

There is a potential race condition between VBucket deletion and
flushVBucket, which can result in dereferencing a deleted pointer,
triggering a segfault.

The issue is in VBucketMap::setPersistenceCheckpointId, which can read
a RCPtr which has just become null.

The issue is on line 177 - we dutifully check if is valid, but then
re-fetch the VBucket - at which point it may have been set to null by
another thread (such as when a VBucket is deleted).  Fix is to just
use the local `vb` to dereference.

Change-Id: I683cb0d0cfe37e710e98ba6bbf1ddd4cf3682a35


COMMENTS

author: Ashlee Kent
date: 2016-11-21 15:10:29.453000000

Uploaded patch set 1.

-------------------------------------
author: Hugo Blankenship
date: 2016-11-21 15:10:38.752000000

Patch Set 1:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-addresssanitizer-watson/495/ (1/4)

-------------------------------------
author: Hugo Blankenship
date: 2016-11-21 15:10:38.954000000

Patch Set 1:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-clang_analyzer-watson/1462/ (2/4)

-------------------------------------
author: Hugo Blankenship
date: 2016-11-21 15:10:39.094000000

Patch Set 1:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-watson/1893/ (3/4)

-------------------------------------
author: Hugo Blankenship
date: 2016-11-21 15:10:39.228000000

Patch Set 1:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-watson/1677/ (4/4)

-------------------------------------
author: Hugo Blankenship
date: 2016-11-21 15:13:12.426000000

Patch Set 1: Verified-1

Build Failed 

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-clang_analyzer-watson/1462/ : ABORTED

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-watson/1893/ : ABORTED

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-watson/1677/ : ABORTED

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-addresssanitizer-watson/495/ : ABORTED

-------------------------------------
author: Tate Garrett
date: 2016-11-21 17:49:49.645000000

Change has been successfully cherry-picked as 21ed005e819813aab36c6a629d97d4b7f6cb5474 by Ashlee Kent

-------------------------------------
