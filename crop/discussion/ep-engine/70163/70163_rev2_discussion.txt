DESCRIPTION

MB-21738: Fix potential crash due to race deleting VBucket

There is a potential race condition in
VBucketMap::setPersistenceCheckpointId during VBucket deletion which
can result in dereferencing a deleted pointer, triggering a segfault.

The issue is that setPersistenceCheckpointId can dereference a RCPtr
which has just become null. The issue is on line 177 - we dutifully
check if is valid, but then re-fetch the VBucket - at which point it
may have been set to null by another thread (such as when a VBucket is
deleted).

Fix is to just use the local `vb` to dereference.

Change-Id: I683cb0d0cfe37e710e98ba6bbf1ddd4cf3682a35


COMMENTS

author: Ashlee Kent
date: 2016-11-21 15:13:11.668000000

Uploaded patch set 2: Commit message was updated.

-------------------------------------
author: Hugo Blankenship
date: 2016-11-21 15:13:18.789000000

Patch Set 2:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-watson/1678/ (1/4)

-------------------------------------
author: Hugo Blankenship
date: 2016-11-21 15:13:18.925000000

Patch Set 2:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-watson/1894/ (2/4)

-------------------------------------
author: Hugo Blankenship
date: 2016-11-21 15:13:19.062000000

Patch Set 2:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-clang_analyzer-watson/1463/ (3/4)

-------------------------------------
author: Hugo Blankenship
date: 2016-11-21 15:13:19.189000000

Patch Set 2:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-addresssanitizer-watson/496/ (4/4)

-------------------------------------
author: Hugo Blankenship
date: 2016-11-21 15:38:07.672000000

Patch Set 2: Verified-1

Build Failed 

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-watson/1894/ : ABORTED

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-clang_analyzer-watson/1463/ : SUCCESS

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-watson/1678/ : SUCCESS

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-addresssanitizer-watson/496/ : SUCCESS

-------------------------------------
author: Hugo Blankenship
date: 2016-11-21 15:38:12.862000000

Patch Set 2: -Verified

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-watson/1895/ (4/4)

-------------------------------------
author: Hugo Blankenship
date: 2016-11-21 16:13:52.616000000

Patch Set 2: Verified-1

Build Failed 

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-watson/1895/ : FAILURE

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-clang_analyzer-watson/1463/ : SUCCESS

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-watson/1678/ : SUCCESS

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-addresssanitizer-watson/496/ : SUCCESS

-------------------------------------
author: Liliana Harmon
date: 2016-11-21 16:58:27.566000000

Patch Set 2: Code-Review+2

-------------------------------------
author: Hugo Blankenship
date: 2016-11-21 16:59:43.749000000

Patch Set 2: -Verified

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-watson/1896/ (4/4)

-------------------------------------
author: Hugo Blankenship
date: 2016-11-21 17:30:21.413000000

Patch Set 2: Verified-1

Build Failed 

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-watson/1896/ : FAILURE

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-clang_analyzer-watson/1463/ : SUCCESS

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-watson/1678/ : SUCCESS

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-addresssanitizer-watson/496/ : SUCCESS

-------------------------------------
author: Hugo Blankenship
date: 2016-11-21 17:30:41.121000000

Patch Set 2: -Verified

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-watson/1898/ (4/4)

-------------------------------------
author: Hugo Blankenship
date: 2016-11-21 17:48:15.714000000

Patch Set 2: Verified+1

Build Successful 

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-clang_analyzer-watson/1463/ : SUCCESS

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-watson/1678/ : SUCCESS

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-addresssanitizer-watson/496/ : SUCCESS

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-watson/1898/ : SUCCESS

-------------------------------------
author: Tate Garrett
date: 2016-11-21 17:49:49.645000000

Change has been successfully cherry-picked as 21ed005e819813aab36c6a629d97d4b7f6cb5474 by Ashlee Kent

-------------------------------------
