DESCRIPTION

MB-18149: Do not generate new CAS value unless DELETE succeeds

Operations that fails should not modify the objects properties
(That would make it impossible for clients to safely delete
the correct version of the object they modified if others
tried to delete the object with an incorrect CAS value)

Change-Id: I92310a095963c1620d1bc4363a7ee4706bc773ec


COMMENTS

author: Asher Vang
date: 2016-02-16 10:56:57.745000000

Uploaded patch set 3: Patch Set 2 was rebased.

-------------------------------------
author: Hugo Blankenship
date: 2016-02-16 10:57:04.322000000

Patch Set 3:

Build Started http://factory.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/1752/ (2/2)

-------------------------------------
author: Hugo Blankenship
date: 2016-02-16 11:03:32.468000000

Patch Set 3: Verified-1

Build Failed 

http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master-multi/2484/ : FAILURE

http://factory.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/1752/ : SUCCESS

-------------------------------------
author: Hugo Blankenship
date: 2016-02-16 11:16:19.545000000

Patch Set 3: -Verified

Build Started http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master-multi/2485/ (2/2)

-------------------------------------
author: Hugo Blankenship
date: 2016-02-16 11:16:30.558000000

Patch Set 3: Verified-1

Build Failed 

http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master-multi/2485/ : FAILURE

http://factory.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/1752/ : SUCCESS

-------------------------------------
author: Hugo Blankenship
date: 2016-02-16 11:18:32.980000000

Patch Set 3: -Verified

Build Started http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master-multi/2486/ (2/2)

-------------------------------------
author: Hugo Blankenship
date: 2016-02-16 11:21:17.563000000

Patch Set 3: Verified-1

Build Failed 

http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master-multi/2486/ : FAILURE

http://factory.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/1752/ : SUCCESS

-------------------------------------
author: Hugo Blankenship
date: 2016-02-16 11:26:54.906000000

Patch Set 3: -Verified

Build Started http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master-multi/2487/ (2/2)

-------------------------------------
author: Hugo Blankenship
date: 2016-02-16 11:33:55.351000000

Patch Set 3: Verified+1

Build Successful 

http://factory.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/1752/ : SUCCESS

http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master-multi/2487/ : SUCCESS

-------------------------------------
author: Ashlee Kent
date: 2016-02-16 12:49:56.270000000

Patch Set 3: Code-Review-1

(1 comment)

Line:2908, src/ep.cc -> Looking at the change when the incorrect CAS mutation was added (http://review.Piper Jefferson.org/59124) the itemMeta population should happen irrespective of if the operation succeeded. Please move this back to where it was.

-------------------------------------
author: Natasha Sullivan
date: 2016-02-16 13:23:15.210000000

Patch Set 3:

(1 comment)

Line:2908, src/ep.cc -> Asher Vang put this in because when you don't have it here the meta test cases fail

-------------------------------------
author: Asher Vang
date: 2016-02-16 14:02:20.272000000

Patch Set 3:

(1 comment)

Line:2908, src/ep.cc -> I would disagree to that... We shuldn't populate the result variables unless the operation succeed...

-------------------------------------
author: Ashlee Kent
date: 2016-02-16 14:33:21.143000000

Patch Set 3:

(1 comment)

Line:2908, src/ep.cc -> The previous code guarded the itemMeta update with `if (v)` - if you restore that I believe the effect will be the same.  

I wanted to minimise the scope of this fix to the minimum required, for ease of porting etc.

-------------------------------------
author: Asher Vang
date: 2016-02-16 15:32:54.220000000

Patch Set 3:

(1 comment)

Line:2908, src/ep.cc -> v is the stored_value so it got to exist for the delete to succeed

-------------------------------------
author: Abby Duran
date: 2016-02-16 19:14:55.781000000

Patch Set 3: Code-Review-1

(1 comment)

Line:2907, src/ep.cc -> A new CAS should be still generated for this case (full eviction with force=true). We will push the new patch soon.

-------------------------------------
author: Asher Vang
date: 2016-02-16 19:17:39.233000000

Patch Set 3:

(1 comment)

Line:2907, src/ep.cc -> Ah, I was wondering which code path this was.. (perhaps worth updating the unit test to verify it as well?)

-------------------------------------
author: Abby Duran
date: 2016-02-16 19:20:48.981000000

Patch Set 3:

(1 comment)

Line:2907, src/ep.cc -> Yeah, that makes sense to me.

-------------------------------------
author: Tate Garrett
date: 2016-02-16 21:56:03.281000000

Change has been successfully cherry-picked as b7d75f923c295ad480cf79730ebf8325b79ac275

-------------------------------------
