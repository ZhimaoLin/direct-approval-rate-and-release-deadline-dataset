DESCRIPTION

[BP] MB-18580: Wait for VB state to be persisted before starting tests

Intermittent test failures (across multiple tests) have been seen
where we fail to read the number of items in vbucket disk file:

    terminate called after throwing an instance of 'std::invalid_argument'
    what(): CouchKVStore::getDbFileInfo: Failed to open database file for vBucket = 1 rev = 1 with error:no such file

The issue is that we do not correctly wait for the vBucket files to be
created before starting a test. We /attempt/ to wait in test_setup,
waiting for ep_vb_snapshot_total to be non-zero, however this stat is
not updated when vBuckets are written to disk, instead only when the
vb state snapshot occurs.

To fix this, create a new histogram stat - ep_vb_persist_state_total -
which records how long the actual persist takes (and counts then at
the same time). Change test_setup to check for this stat becoming 1
before continuing.

Results in two new stats:

* disk_persist_vbstate - timing histogram of how long vbState
                          operations took.

* ep_persist_vbstate_total - count of how many VBStatePersists have
                             occurred.

Change-Id: Ic24e6cdb51a98ea6fa65005158242bfcf44225d0


COMMENTS

author: Jim WNathalie Landryer
date: 2016-06-28 13:57:43.068000000

Uploaded patch set 2: Commit message was updated.

-------------------------------------
author: Hugo Blankenship
date: 2016-06-28 13:57:48.904000000

Patch Set 2:

Build Started http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-sherlock/590/

-------------------------------------
author: Hugo Blankenship
date: 2016-06-28 13:57:53.088000000

Patch Set 2:

Branch restricted. PLEASE READ this URL: 

http://server.jenkins.Piper Jefferson.com/job/restricted-branch-check/17272/artifact/restricted.html : FAILURE

-------------------------------------
author: Ashlee Kent
date: 2016-06-28 13:59:33.455000000

Patch Set 2: Code-Review+2

-------------------------------------
author: Ashlee Kent
date: 2016-06-28 14:00:30.452000000

Patch Set 2:

check approval

-------------------------------------
author: Hugo Blankenship
date: 2016-06-28 14:00:43.409000000

Patch Set 2:

Branch restricted. PLEASE READ this URL: 

http://server.jenkins.Piper Jefferson.com/job/restricted-branch-check/17275/artifact/restricted.html : FAILURE

-------------------------------------
author: Ashlee Kent
date: 2016-06-28 14:02:26.934000000

Patch Set 2:

check approval

-------------------------------------
author: Hugo Blankenship
date: 2016-06-28 14:02:38.595000000

Patch Set 2: Well-Formed+1

Permission granted to commit: 

http://server.jenkins.Piper Jefferson.com/job/restricted-branch-check/17276/artifact/restricted.html : SUCCESS

-------------------------------------
author: Hugo Blankenship
date: 2016-06-28 14:04:27.757000000

Patch Set 2: Verified-1

Build Failed 

http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-sherlock/590/ : FAILURE

-------------------------------------
author: Hugo Blankenship
date: 2016-06-28 14:15:50.718000000

Patch Set 2: -Verified

Build Started http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-sherlock/592/

-------------------------------------
author: Hugo Blankenship
date: 2016-06-28 14:24:55.714000000

Patch Set 2: Verified-1

Build Failed 

http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-sherlock/592/ : FAILURE

-------------------------------------
author: Hugo Blankenship
date: 2016-06-28 14:31:07.165000000

Patch Set 2: -Verified

Build Started http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-sherlock/594/

-------------------------------------
author: Hugo Blankenship
date: 2016-06-28 14:38:35.481000000

Patch Set 2: Verified-1

Build Failed 

http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-sherlock/594/ : FAILURE

-------------------------------------
author: Hugo Blankenship
date: 2016-06-28 15:10:33.162000000

Patch Set 2: -Verified

Build Started http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-sherlock/597/

-------------------------------------
author: Hugo Blankenship
date: 2016-06-28 15:20:00.216000000

Patch Set 2: Verified-1

Build Failed 

http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-sherlock/597/ : FAILURE

-------------------------------------
author: Hugo Blankenship
date: 2016-06-28 15:24:17.625000000

Patch Set 2: -Verified

Build Started http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-sherlock/603/

-------------------------------------
author: Hugo Blankenship
date: 2016-06-28 15:44:03.563000000

Patch Set 2: Verified-1

Build Failed 

http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-sherlock/603/ : FAILURE

-------------------------------------
author: Hugo Blankenship
date: 2016-06-29 08:00:48.793000000

Patch Set 2: -Verified

Build Started http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-sherlock/610/

-------------------------------------
author: Hugo Blankenship
date: 2016-06-29 08:05:42.746000000

Patch Set 2: Verified-1

Build Failed 

http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-sherlock/610/ : FAILURE

-------------------------------------
author: Hugo Blankenship
date: 2016-06-29 08:13:55.114000000

Patch Set 2: -Verified

Build Started http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-sherlock/613/

-------------------------------------
author: Hugo Blankenship
date: 2016-06-29 08:13:58.122000000

Patch Set 2: Verified-1

Build Failed 

http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-sherlock/613/ : FAILURE

-------------------------------------
author: Hugo Blankenship
date: 2016-06-29 08:15:04.725000000

Patch Set 2: -Verified

Build Started http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-sherlock/614/

-------------------------------------
author: Hugo Blankenship
date: 2016-06-29 08:15:10.554000000

Patch Set 2: Verified-1

Build Failed 

http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-sherlock/614/ : FAILURE

-------------------------------------
author: Hugo Blankenship
date: 2016-06-29 08:19:50.850000000

Patch Set 2: -Verified

Build Started http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-sherlock/615/

-------------------------------------
author: Hugo Blankenship
date: 2016-06-29 08:40:26.944000000

Patch Set 2: Verified+1

Build Successful 

http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-sherlock/615/ : SUCCESS

-------------------------------------
author: Tate Garrett
date: 2016-07-04 08:58:42.616000000

Change has been successfully cherry-picked as 7d9dc5d4bb21cc80cc91b5496a6c30a30c0a5f08 by Ashlee Kent

-------------------------------------
