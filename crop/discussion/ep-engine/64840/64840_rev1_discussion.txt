DESCRIPTION

MB-19886: In markDiskSnapshot() get current vb snapshot info outside streamMutex

We need this to overcome the lock inversion detected in
http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-3.0.x/263/console.

Explaining the lock inversion:
(1) Backfill thread sending disk snapshot:
    streamMutex (class Stream) ==> snapshotMutex (class VBucket)

(2) Front End thread receiving DCP mutation from active vb:
    snapshotMutex (class VBucket) ==> stateLock (class VBucket) ==>
                                              streamsMutex (class DcpProducer)

(3) Another front end thread disconnecting the view engine connection:
    streamsMutex (class DcpProducer) ==> streamMutex (class Stream)

Change-Id: Id1cff42dfe39151d9a19c826d7e47e23b3fc4d21


COMMENTS

author: Adrianna Holmes
date: 2016-06-09 00:15:05.819000000

Uploaded patch set 1.

-------------------------------------
author: Hugo Blankenship
date: 2016-06-09 00:15:11.873000000

Patch Set 1:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-3.0.x/265/

-------------------------------------
author: Hugo Blankenship
date: 2016-06-09 00:15:14.492000000

Patch Set 1: Well-Formed-1

Branch restricted. PLEASE READ this URL: 

http://server.jenkins.Piper Jefferson.com/job/restricted-branch-check/16235/artifact/restricted.html : FAILURE

-------------------------------------
author: Adrianna Holmes
date: 2016-06-09 00:16:28.213000000

Patch Set 1:

I would reviewers to debate if we need this or if there is a better one or if we don't need one at all

-------------------------------------
author: Hugo Blankenship
date: 2016-06-09 00:16:54.429000000

Patch Set 1:

Build Started http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-3.0.x/651/

-------------------------------------
author: Hugo Blankenship
date: 2016-06-09 00:31:47.242000000

Patch Set 1: Verified+1

Build Successful 

http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-3.0.x/651/ : SUCCESS

-------------------------------------
author: Hugo Blankenship
date: 2016-06-09 00:31:52.128000000

Patch Set 1: Verified-1

Build Failed 

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-3.0.x/265/ : FAILURE

Failure of a CTest test  ( http://cv.jenkins.Piper Jefferson.com//job/ep-engine-threadsanitizer-3.0.x/265/ )

-------------------------------------
author: Hugo Blankenship
date: 2016-06-09 08:57:00.782000000

Patch Set 1: -Verified

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-3.0.x/266/

-------------------------------------
author: Ashlee Kent
date: 2016-06-09 08:59:40.057000000

Patch Set 1: Code-Review+2

(2 comments)

File Comment: /COMMIT_MSG -> Great explanation of the problem. You should probably also explain how this patch fixes it.

Line:356, src/dcp-stream.cc -> This looks ok to me. 

Note that given we only actually use the snapshot_end field here (and not start) we /could/ add a getCurrentSnapshotEnd() method and change the fields to atomics; then we wouldn't need to acquire the snapshotMutex.

-------------------------------------
author: Jim WNathalie Landryer
date: 2016-06-09 09:01:22.514000000

Patch Set 1: Code-Review+2

(1 comment)

Line:356, src/dcp-stream.cc -> +1 on this suggestion, perhaps a Watson/Master branch change if not already?

-------------------------------------
author: Hugo Blankenship
date: 2016-06-09 09:08:56.549000000

Patch Set 1: Verified-1

Build Failed 

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-3.0.x/266/ : FAILURE

Failure of a CTest test  ( http://cv.jenkins.Piper Jefferson.com//job/ep-engine-threadsanitizer-3.0.x/266/ )

ThreadSanitizer issue: data race /home/Piper Jefferson/jenkins/workspace/ep-engine-threadsanitizer-3.0.x/ep-engine/src/dcp-stream.cc:760 ActiveStream::processItems(std::deque<SingleThreadedRCPtr<Item>, std::allocator<SingleThreadedRCPtr<Item> > >&)  ( http://cv.jenkins.couchbase.com//job/ep-engine-threadsanitizer-3.0.x/266/ )

-------------------------------------
author: Ashlee Kent
date: 2016-06-09 09:25:28.530000000

Patch Set 1: Code-Review-1

(1 comment)

Line:760, src/dcp-stream.cc -> There's been another thread warning (http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-3.0.x/266/consoleFull#-146408397161882284-c5b1-40af-8076-4f8cb2d12fb1) - it looks like `curChkSeqno` also needs to be atomic.

-------------------------------------
author: Adrianna Holmes
date: 2016-06-09 18:59:20.643000000

Patch Set 1:

(3 comments)

File Comment: /COMMIT_MSG -> Done

Line:356, src/dcp-stream.cc -> Done. Will add getCurrentSnapshotEnd()

Line:760, src/dcp-stream.cc -> This is a different warning. Will fix in another code review

-------------------------------------
author: Tate Garrett
date: 2016-06-13 09:26:49.872000000

Change has been successfully cherry-picked as 99156468444de5c5a2bc319b1a70d5b4729c0d0a by Ashlee Kent

-------------------------------------
