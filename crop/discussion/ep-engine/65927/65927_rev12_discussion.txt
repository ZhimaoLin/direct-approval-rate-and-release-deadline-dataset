DESCRIPTION

MB-19955: Reduce NOOP interval to one second

ns_server plan to spy on dcp traffic to determine whether a
node is healthy.  Therefore on an idle node they need to
ensure a DCP NOOP message is sent at a one second interval.

This patch reduces the NOOP interval to one second.
It also modifies the ConnManager task to invoke the
manageConnections function once a second.

The connection timeout is changed from being twice the NOOP
interval to being a separate dedicated configuration option.

The decision of whether to disconnect is moved outside the
maybeSendNoop function into a dedicated maybeDisconnect
function.

Change-Id: I1b47e46fcd84a8d7f6a2f885b0120863d031b251


COMMENTS

author: Kymani Ramirez
date: 2016-08-09 15:23:11.475000000

Uploaded patch set 12.

-------------------------------------
author: Hugo Blankenship
date: 2016-08-09 15:23:21.392000000

Patch Set 12:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master/1116/ (1/3)

-------------------------------------
author: Hugo Blankenship
date: 2016-08-09 15:26:25.506000000

Patch Set 12:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/1028/ (2/3)

-------------------------------------
author: Hugo Blankenship
date: 2016-08-09 15:29:26.441000000

Patch Set 12:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-clang_analyzer-master/869/ (3/3)

-------------------------------------
author: Hugo Blankenship
date: 2016-08-09 15:46:48.233000000

Patch Set 12: Verified+1

Build Successful 

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/1028/ : SUCCESS

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-clang_analyzer-master/869/ : SUCCESS

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master/1116/ : SUCCESS

-------------------------------------
author: Ashlee Kent
date: 2016-08-09 15:55:39.984000000

Patch Set 12: Code-Review-1

(7 comments)

Line:368, tests/module_tests/dcp_test.cc -> Can we use the actual applicable setting (i.e. config.getXXXNoopTimeout() + 1) instead of a hard-coded value?

Line:371, tests/module_tests/dcp_test.cc -> Can we also test maybeSendNoop() returning SUCCESS (or whatever it returns when a loop is sent).

Line:379, tests/module_tests/dcp_test.cc -> Similar here - can we also test the other case?

Line:222, src/dcp/producer.h -> Would be helpful to describe what the possible return values are.

Line:227, src/dcp/producer.h -> Same

Line:611, configuration.json -> Is this true? Isn't it the maximum time between /any/ DCP message being recieved?

Line:209, src/dcp/consumer.h -> again, is this between noops or any DCP message?

-------------------------------------
author: Jim WNathalie Landryer
date: 2016-08-10 08:20:30.388000000

Patch Set 12: Code-Review-1

(3 comments)

Line:381, tests/module_tests/dcp_test.cc -> nit: correct the indent since you're changing this line

Line:611, configuration.json -> This is being used by the consumer for any message, not just noop.

Line:1005, src/dcp/consumer.cc -> Note that 'noopInterval * 2' is part of the DCP documentation, so you'll need to make updates to that too. https://github.com/Piper Jeffersonlabs/dcp-documentation/blob/master/documentation/commands/no-op.md

-------------------------------------
author: Kymani Ramirez
date: 2016-08-10 10:32:09.583000000

Patch Set 12:

(9 comments)

Line:368, tests/module_tests/dcp_test.cc -> Done

Line:371, tests/module_tests/dcp_test.cc -> That is what the next line is doing.  i.e. when a noop is successfully sent it sends ENGINE_WANT_MORE.
I will add a comment so it is clearer.
I will also add a test for when we don't send a noop

Line:379, tests/module_tests/dcp_test.cc -> Added a comment below to make it clearer we are testing to see if disconnecting.
I'm also adding the other test for when we want to continue.  i.e. return ENGINE_FAILED.

Line:381, tests/module_tests/dcp_test.cc -> Done

Line:222, src/dcp/producer.h -> Done

Line:227, src/dcp/producer.h -> Done

Line:611, configuration.json -> Sorry - yes you are correct should be any DCP message.
updated accordingly.

Line:209, src/dcp/consumer.h -> yes your right should be any message.
Updated accordingly.

Line:1005, src/dcp/consumer.cc -> Will do... As a separate note: Why don't we move the documentation into the ep-engine repository?

-------------------------------------
author: Tate Garrett
date: 2016-08-11 10:31:24.944000000

Change has been successfully cherry-picked as dd2bf1e141fce5563ff13d76817b761b57c63576 by Ashlee Kent

-------------------------------------
