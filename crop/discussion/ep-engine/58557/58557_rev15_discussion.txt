DESCRIPTION

Save the state of vbucket in an active stream's context

Do not attempt to check vbucket state everytime
while processing data in an active stream. Instead,
save a cached copy of the vbucket state acquired
during creation.

This change is to avert potential deadlocks due to
lock inversion that will be induced by upcoming changes,
here are the scenarios:
(i)     Locking between streamsMutex, streamMutex and
        vb_stateLock in the set operation - handle
        response scenario.
        (http://factory.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/1225/console)
(ii)    In case of a set operation, vb_stateLock is
        acquired and then streamMutex is acquired for
        notification. During markDiskSnapshot, the
        streamMutex is acquired before the vb_stateLock
        lock is acquired.
        (http://factory.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/1268/console)

Change-Id: Iddb518b5e94a4595c62026f797ff17ba790d180c


COMMENTS

author: Emerson Nolan
date: 2016-01-15 16:40:35.387000000

Uploaded patch set 15.

-------------------------------------
author: Hugo Blankenship
date: 2016-01-15 16:40:40.305000000

Patch Set 15:

Build Started http://factory.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/1288/ (2/2)

-------------------------------------
author: Emerson Nolan
date: 2016-01-15 16:47:13.655000000

Patch Set 15:

@Dave So regarding the possibility of it being stale: the stream would be closed before the vbucket state changes (to anything). Could you perhaps throw some light on how you believe the state could become stale for a stream that is not dead?

-------------------------------------
author: Hugo Blankenship
date: 2016-01-15 16:54:20.414000000

Patch Set 15: Verified+1

Build Successful 

http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master-multi/2049/ : SUCCESS

http://factory.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/1288/ : SUCCESS

-------------------------------------
author: Emerson Nolan
date: 2016-01-15 17:17:42.952000000

Patch Set 15:

@Chiyoung @Dave Adopting Chiyoung's suggestion of getting rid of the stateLock in situations where we can do without, in the next patch.

-------------------------------------
author: Tate Garrett
date: 2016-01-18 17:24:14.696000000

Change has been successfully cherry-picked as ec5dbdc3f35743ff885d55c0efe455446141243f

-------------------------------------
