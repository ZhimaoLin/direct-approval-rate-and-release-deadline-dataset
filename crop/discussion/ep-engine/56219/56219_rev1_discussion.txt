DESCRIPTION

MB-16574: Log when cluster config is changed

Change-Id: I0b234e6330ab3e5c0cde84c14977aff8034000d6


COMMENTS

author: Ashlee Kent
date: 2015-10-19 11:41:44.613000000

Uploaded patch set 1.

-------------------------------------
author: Hugo Blankenship
date: 2015-10-19 11:41:49.696000000

Patch Set 1:

Build Started http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-sherlock/342/

-------------------------------------
author: Hugo Blankenship
date: 2015-10-19 12:01:33.979000000

Patch Set 1: Verified+1

Build Successful 

http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-sherlock/342/ : SUCCESS

-------------------------------------
author: Asher Vang
date: 2015-10-20 13:27:01.025000000

Patch Set 1: Code-Review+1

(1 comment)

Line:5789, src/ep_engine.cc -> Why not parse the config and pick out the revision? It would of course be slower, but I think it would be better to be absolutely sure we log the interesting information rather than omitting something. In addition to this I think we need to verify that we log the state transitions on the vbuckets (so that we can see how long it takes from the state change on the node until it start serving the correct vbucket map).

-------------------------------------
author: Ashlee Kent
date: 2015-10-20 15:47:21.717000000

Patch Set 1:

(1 comment)

Line:5789, src/ep_engine.cc -> A couple of reasons:

1. Conceptually the config is opaque to ep-engine - it's just a blob of data ns_server sends us and we hand over. Therefore *if* we did add knowledge that it's JSON to ep-engine we essentially break that API (and theory make it harder to change)

2. The MB is targeted at 4.1 - I wanted to do something quick and low risk that was easy to add to that branch.

-------------------------------------
author: Abby Duran
date: 2015-10-20 16:25:56.102000000

Patch Set 1: Code-Review+2

-------------------------------------
author: Abby Duran
date: 2015-10-20 16:27:33.135000000

Patch Set 1:

I like Trond's suggestion to log the vbucket state change, which can be addressed as a separate commit.

-------------------------------------
author: Tate Garrett
date: 2015-10-20 16:27:35.909000000

Change has been successfully cherry-picked as 0730282149c1ddba6da19de32cddb4463a528ad7

-------------------------------------
author: Asher Vang
date: 2015-10-20 16:29:52.911000000

Patch Set 1:

(1 comment)

Line:5789, src/ep_engine.cc -> then perhaps we should just dump the entire thing in the log? Given that the orders of the elements in the json document we could end up without any valuable information in the logs from just dumping the 100 first bytes.

-------------------------------------
author: Ashlee Kent
date: 2015-10-20 16:37:07.300000000

Patch Set 1:

(1 comment)

Line:5789, src/ep_engine.cc -> In theory yes, but in practice I've always seen the rev at the start.

As per Chiyoung's comment, if we're going to parse it lets' do that for watson as it'll be a more invasive change.

-------------------------------------
