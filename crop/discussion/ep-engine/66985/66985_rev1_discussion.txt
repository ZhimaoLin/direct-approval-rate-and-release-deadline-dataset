DESCRIPTION

MB-20649: Fix lock inversion between Processor and front-end

Processor via PassiveStream::processBufferedMessage has a lock-inversion
for setVbucketState messages.

The Processor obtains bufMutex then connManager
Frontend is path is reversed, connManger then bufMutex

Change-Id: I2ad3c798730ac360f3260b17dd967c44237099b7


COMMENTS

author: Jim WNathalie Landryer
date: 2016-08-23 12:29:49.079000000

Uploaded patch set 1.

-------------------------------------
author: Hugo Blankenship
date: 2016-08-23 12:29:55.096000000

Patch Set 1:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master/1183/ (1/3)

-------------------------------------
author: Jim WNathalie Landryer
date: 2016-08-23 12:32:38.476000000

Patch Set 1: Code-Review-1

seeing if i can get a proper test-case, only see TSAN problem by forcing the buffered code path with a code change

-------------------------------------
author: Hugo Blankenship
date: 2016-08-23 12:36:56.332000000

Patch Set 1:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/1092/ (2/3)

-------------------------------------
author: Hugo Blankenship
date: 2016-08-23 12:43:48.423000000

Patch Set 1:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-clang_analyzer-master/927/ (3/3)

-------------------------------------
author: Hugo Blankenship
date: 2016-08-23 12:57:24.232000000

Patch Set 1: Verified-1

Build Failed 

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master/1183/ : FAILURE

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/1092/ : FAILURE

Failure of a CTest test 16/32 Test  #8: ep-engine_ep_unit_tests ............... ( http://cv.jenkins.Piper Jefferson.com//job/ep-engine-threadsanitizer-master/1092/ )

ThreadSanitizer issue: heap-use-after-free (virtual call vs free) /home/Piper Jefferson/jenkins/workspace/ep-engine-threadsanitizer-master/ep-engine/src/dcp/stream.cc:1616 PassiveStream::processBufferedMessages(unsigned int&, unsigned long)  ( http://cv.jenkins.couchbase.com//job/ep-engine-threadsanitizer-master/1092/ )

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-clang_analyzer-master/927/ : SUCCESS

-------------------------------------
