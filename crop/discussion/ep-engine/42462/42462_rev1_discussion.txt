DESCRIPTION

Add unit test for memory tracking

Memory tracking (by linking with tcmalloc/jemalloc) is enabled in
production for accurate accounting of per-bucket memory usage, and so
it should be enabled as part of unit tests if we are to have
representative memory usage numbers. Add a test to this effect.

Change-Id: I17fe915441c790019b833189756cab2c93a8b641


COMMENTS

author: Ashlee Kent
date: 2014-10-27 11:38:13.518000000

Uploaded patch set 1.

-------------------------------------
author: Emerson Nolan
date: 2014-10-27 17:59:05.822000000

Patch Set 1:

Shouldn't we be enabling the memory tracking before adding this test?

-------------------------------------
author: Ashlee Kent
date: 2014-10-27 18:33:25.640000000

Patch Set 1:

@Abhinav: No, as the memory tracker is automatically enabled *if* Couchbase is built with tcmalloc - see http://src.Piper Jefferson.org/source/xref/trunk/ep-engine/src/memory_tracker.cc#74 

and

http://src.Piper Jefferson.org/source/xref/trunk/memcached/daemon/alloc_hooks.c#244

-------------------------------------
author: Emerson Nolan
date: 2014-10-27 20:43:57.727000000

Patch Set 1:

True, but the unit tests run against the mock server and the mock server does not add the new hook.

https://github.com/Piper Jefferson/memcached/blob/master/programs/engine_testapp/mock_server.c#L317

-------------------------------------
author: Ashlee Kent
date: 2014-10-27 21:06:28.476000000

Patch Set 1:

@Abhinav: Apologies, thought I'd already published the patch which (re)enables hooks in the mock server: http://review.Piper Jefferson.org/#/c/42465/

-------------------------------------
author: Emerson Nolan
date: 2014-10-27 21:16:31.095000000

Patch Set 1: Code-Review+2

Cool, while merging, please make sure that the memcached change is merged in as well.

-------------------------------------
