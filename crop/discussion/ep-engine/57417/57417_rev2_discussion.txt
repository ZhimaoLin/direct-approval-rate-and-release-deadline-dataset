DESCRIPTION

MB-16949: BackfillManager: Fix leak due to circular reference

There is a circular reference between BackfillManager and DcpProducer,
which means that BackfillManager is never deleted. This is caused by
BackfillManager holding an (unused) SingleThreadedRCPtr to
DcpProducer.

Fix this by Removing this unused smart pointer. Unfortunately exposes
a latent deadlock when destructing BackfillManager - ~BackfillManager
(indirectly) calls ~ActiveStream, which in turn calls
BackfillManager::bytesSent() which attempts to acquire the Backfill
lock; however the lock is already acquired in ~BackfillManager.

Fix this by removing the call to bytesSent() in ~ActiveStream - as
it's already been updated in other methods.

The now correct deletion of DcpProducer and the smart-pointer
triggered deletion of ActiveStream leads to a lock-inversion
problem in that different locks are being acquired in different
orders on the possible deletion paths.

Fix this by removing the lock acquisition from destructors.
The locks in destructors are providing no protection, no
code should be refering to the deleting object, they risk
accessing freed memory with or without the locks.

Change-Id: Id79fbf8bc39463d4874c2f61378b7f110345631b


COMMENTS

author: Jim WNathalie Landryer
date: 2015-12-07 12:30:14.486000000

Uploaded patch set 2.

-------------------------------------
author: Hugo Blankenship
date: 2015-12-07 12:30:21.995000000

Patch Set 2:

Build Started http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-sherlock/356/

-------------------------------------
author: Jim WNathalie Landryer
date: 2015-12-07 12:43:21.388000000

Patch Set 2:

The master patch now seems clean on TSAN so pushing the sherlock one

-------------------------------------
author: Hugo Blankenship
date: 2015-12-07 12:50:05.120000000

Patch Set 2: Verified-1

Build Failed 

http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-sherlock/356/ : FAILURE

-------------------------------------
author: Hugo Blankenship
date: 2015-12-07 12:59:46.563000000

Patch Set 2: -Verified

Build Started http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-sherlock/357/

-------------------------------------
author: Hugo Blankenship
date: 2015-12-07 13:05:20.453000000

Patch Set 2: Verified+1

Build Successful 

http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-sherlock/357/ : SUCCESS

-------------------------------------
author: Ashlee Kent
date: 2015-12-07 13:10:53.878000000

Patch Set 2: Code-Review+1

> The master patch now seems clean on TSAN so pushing the sherlock
 > one

Looks good. Could you also update the master one so we have a confirmed clean threadSanitizer run on Jenkins?

-------------------------------------
author: Jim WNathalie Landryer
date: 2015-12-07 13:47:17.997000000

Patch Set 2:

> > The master patch now seems clean on TSAN so pushing the sherlock
 > > one
 > 
 > Looks good. Could you also update the master one so we have a
 > confirmed clean threadSanitizer run on Jenkins?

It's there and has SUCCESS from Hugo Blankenship

-------------------------------------
author: Ashlee Kent
date: 2015-12-07 13:47:32.449000000

Patch Set 2: Code-Review+2

-------------------------------------
author: Adrianna Holmes
date: 2015-12-07 20:00:38.167000000

Patch Set 2:

(1 comment)

Line:610, src/dcp-stream.cc -> Why should we not reset bufferedBackfill.bytes and bufferedBackfill.items to zero here ? If some logic gets added with stream in dead state (I know we should not add such a logic, but it can happen), it is good to have these parameters at zero.

-------------------------------------
author: Ashlee Kent
date: 2015-12-08 14:13:06.541000000

Patch Set 2:

(1 comment)

Line:610, src/dcp-stream.cc -> Good suggestion - will fix.

-------------------------------------
author: Tate Garrett
date: 2015-12-16 02:41:44.951000000

Change has been successfully cherry-picked as 4587de828846a72837656bb1e5a6121a3faba42c

-------------------------------------
