DESCRIPTION

MB-5027 Avoid duplicated vbucket state settings

Vbuckets snapshots actually set vbuckets state even though state is
same as the new state. In ep-store, this redundant operations mean
extra wasted dispatcher works to kvstore; in couch-kvstore, this
would mean unnecessary couchstore new header position operations
and wasted notify_update to mccouch. All these performance waste
can be saved by a simple state check before setting new state.

Change-Id: I0b49007b82cf77aaf2d298cdf95f6bae92e3a046


COMMENTS

author: Roman Murillo
date: 2012-05-30 20:50:01.333000000

Uploaded patch set 2.

-------------------------------------
author: Roman Murillo
date: 2012-05-30 21:00:12.237000000

Patch Set 2: Verified

verified on linux as well.

-------------------------------------
author: Nathalie Landry
date: 2012-05-30 21:01:43.880000000

Patch Set 2:

not sure if that matters but 2 concurrent setVbucketState can observe that vbucket is missing and then proceed and create it 2 times (because of reading vb before grabbing lock).

Not sure it's bad though

-------------------------------------
author: Abby Duran
date: 2012-05-30 21:31:55.776000000

Patch Set 2: I would prefer that you didn't submit this

(1 inline comment)



Line:1022, ep.cc -> As I mentioned in your earlier commit, we should grab the lock before getting the vbucket instance. Please move grabbing the lock to the beginning of this function.

-------------------------------------
