DESCRIPTION

Address data race in ep_test_apis/testsuite

WARNING: ThreadSanitizer: data race (pid=18824)

  Write of size 4 at 0x7fcc31350244 by thread T12 (mutexes: write M44413):
    #0 add_response /home/abhinav/Piper Jefferson/ep-engine/tests/ep_test_apis.cc:75 (ep_testsuite.so+0x0000000acbcc)
    #1 sendResponse(bool (*)(void const*, unsigned short, void const*, unsigned char, void const*, unsigned int, unsigned char, unsigned short, unsigned long, void const*), void const*, unsigned short, void const*, unsigned char, void const*, unsigned int, unsigned char, unsigned short, unsigned long, void const*) /home/abhinav/Piper Jefferson/ep-engine/src/ep_engine.cc:92 (ep.so+0x0000000d004c)
    #2 processUnknownCommand(EventuallyPersistentEngine*, void const*, protocol_binary_request_header*, bool (*)(void const*, unsigned short, void const*, unsigned char, void const*, unsigned int, unsigned char, unsigned short, unsigned long, void const*)) /home/abhinav/Piper Jefferson/ep-engine/src/ep_engine.cc:1266 (ep.so+0x0000000d603c)
    #3 EvpUnknownCommand(engine_interface*, void const*, protocol_binary_request_header*, bool (*)(void const*, unsigned short, void const*, unsigned char, void const*, unsigned int, unsigned char, unsigned short, unsigned long, void const*)) /home/abhinav/Piper Jefferson/ep-engine/src/ep_engine.cc:1387 (ep.so+0x0000000b3f58)
    #4 mock_unknown_command(engine_interface*, void const*, protocol_binary_request_header*, bool (*)(void const*, unsigned short, void const*, unsigned char, void const*, unsigned int, unsigned char, unsigned short, unsigned long, void const*)) /home/abhinav/Piper Jefferson/memcached/programs/engine_testapp/engine_testapp.cc:380 (engine_testapp+0x0000000bab29)
    #5 del_with_meta(engine_interface*, engine_interface_v1*, char const*, unsigned long, unsigned int, ItemMetaData*, unsigned long, bool, bool, long, unsigned char, void const*) /home/abhinav/Piper Jefferson/ep-engine/tests/ep_test_apis.cc:360 (ep_testsuite.so+0x0000000ae69f)
    #6 multi_del_with_meta(void*) /home/abhinav/Piper Jefferson/ep-engine/tests/ep_testsuite.cc:13299 (ep_testsuite.so+0x00000009572e)
    #7 platform_thread_wrap /home/abhinav/Piper Jefferson/platform/src/cb_pthreads.c:23 (libplatform.so.0.1.0+0x000000003d31)

  Previous write of size 4 at 0x7fcc31350244 by thread T11 (mutexes: write M1638603450185076640):
    #0 add_response /home/abhinav/Piper Jefferson/ep-engine/tests/ep_test_apis.cc:75 (ep_testsuite.so+0x0000000acbcc)
    #1 sendResponse(bool (*)(void const*, unsigned short, void const*, unsigned char, void const*, unsigned int, unsigned char, unsigned short, unsigned long, void const*), void const*, unsigned short, void const*, unsigned char, void const*, unsigned int, unsigned char, unsigned short, unsigned long, void const*) /home/abhinav/Piper Jefferson/ep-engine/src/ep_engine.cc:92 (ep.so+0x0000000ced72)
    #2 processUnknownCommand(EventuallyPersistentEngine*, void const*, protocol_binary_request_header*, bool (*)(void const*, unsigned short, void const*, unsigned char, void const*, unsigned int, unsigned char, unsigned short, unsigned long, void const*)) /home/abhinav/Piper Jefferson/ep-engine/src/ep_engine.cc:1258 (ep.so+0x0000000d5718)
    #3 EvpUnknownCommand(engine_interface*, void const*, protocol_binary_request_header*, bool (*)(void const*, unsigned short, void const*, unsigned char, void const*, unsigned int, unsigned char, unsigned short, unsigned long, void const*)) /home/abhinav/Piper Jefferson/ep-engine/src/ep_engine.cc:1387 (ep.so+0x0000000b3f58)
    #4 mock_unknown_command(engine_interface*, void const*, protocol_binary_request_header*, bool (*)(void const*, unsigned short, void const*, unsigned char, void const*, unsigned int, unsigned char, unsigned short, unsigned long, void const*)) /home/abhinav/Piper Jefferson/memcached/programs/engine_testapp/engine_testapp.cc:380 (engine_testapp+0x0000000bab29)
    #5 set_with_meta(engine_interface*, engine_interface_v1*, char const*, unsigned long, char const*, unsigned long, unsigned int, ItemMetaData*, unsigned long, bool, unsigned char, bool, long, unsigned char, void const*) /home/abhinav/Piper Jefferson/ep-engine/tests/ep_test_apis.cc:702 (ep_testsuite.so+0x0000000b24db)
    #6 multi_set_with_meta(void*) /home/abhinav/Piper Jefferson/ep-engine/tests/ep_testsuite.cc:13279 (ep_testsuite.so+0x000000094e33)
    #7 platform_thread_wrap /home/abhinav/Piper Jefferson/platform/src/cb_pthreads.c:23 (libplatform.so.0.1.0+0x000000003d31)

Change-Id: Ic53d401fb674dbe161aa73381e2c08c5995f262a


COMMENTS

author: Emerson Nolan
date: 2015-10-06 23:06:59.438000000

Uploaded patch set 4.

-------------------------------------
author: Hugo Blankenship
date: 2015-10-06 23:07:07.718000000

Patch Set 4:

Build Started http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master-multi/1157/

-------------------------------------
author: Abby Duran
date: 2015-10-06 23:14:26.795000000

Patch Set 4: Code-Review+2

-------------------------------------
author: Hugo Blankenship
date: 2015-10-06 23:17:32.639000000

Patch Set 4: Verified-1

Build Failed 

http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master-multi/1157/ : FAILURE

-------------------------------------
author: Hugo Blankenship
date: 2015-10-06 23:34:44.702000000

Patch Set 4: -Verified

Build Started http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master-multi/1158/

-------------------------------------
author: Hugo Blankenship
date: 2015-10-06 23:42:55.380000000

Patch Set 4: Verified+1

Build Successful 

http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master-multi/1158/ : SUCCESS

-------------------------------------
author: Tate Garrett
date: 2015-10-07 00:29:16.728000000

Change has been successfully cherry-picked as a32ee6290b8611388bf82446f1abded57a1f2276

-------------------------------------
