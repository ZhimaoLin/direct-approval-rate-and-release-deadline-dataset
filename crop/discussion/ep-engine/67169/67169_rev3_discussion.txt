DESCRIPTION

MB-20716: Ensure DCP connections in EWOULDBLOCK are unpaused on bucket delete

When a bucket delete occurs, memcached notifies the deleted engine via
the ON_DELETE_BUCKET callback, which in turn calls
DCPConnmap::shutdownAllConnections(). This correctly shuts down all
the DCP streams associated with DCP connections, however if any of
these DCP connections are in the EWOULDBLOCK state - i.e. the frontend
is waiting for a notify_IO_complete call to "wake" them up, then the
frontend will be blocked waiting for a notify_IO_complete which will
never arrive.

This behaviour is essentially a latent bug, however prior to the fix
for MB-20549, memcached would (incorrectly) call signalIfIdle on
connections in the EWOULDBLOCK state, forcing them to wake up. With
that fix in place this longer occurs.

The solution here is to explictly unpause all producer connections
when all streams are closed.

Change-Id: Ia105e78304f5481bb56a0c0ff1cfc973959e1016


COMMENTS

author: Ashlee Kent
date: 2016-08-30 15:17:48.580000000

Uploaded patch set 3.

-------------------------------------
author: Hugo Blankenship
date: 2016-08-30 15:17:55.906000000

Patch Set 3:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-watson/1038/ (1/3)

-------------------------------------
author: Hugo Blankenship
date: 2016-08-30 15:17:56.052000000

Patch Set 3:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-watson/931/ (2/3)

-------------------------------------
author: Hugo Blankenship
date: 2016-08-30 15:17:56.441000000

Patch Set 3: Well-Formed+1

Permission granted to commit: 

http://server.jenkins.Piper Jefferson.com/job/restricted-branch-check/22227/artifact/restricted.html : SUCCESS

-------------------------------------
author: Hugo Blankenship
date: 2016-08-30 15:17:57.662000000

Patch Set 3:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-clang_analyzer-watson/770/ (3/3)

-------------------------------------
author: Jim WNathalie Landryer
date: 2016-08-30 15:25:04.344000000

Patch Set 3: Code-Review+2

-------------------------------------
author: Hugo Blankenship
date: 2016-08-30 15:27:05.516000000

Patch Set 3: Verified-1

Build Failed 

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-watson/1038/ : FAILURE

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-watson/931/ : SUCCESS

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-clang_analyzer-watson/770/ : SUCCESS

-------------------------------------
author: Hugo Blankenship
date: 2016-08-30 15:31:43.142000000

Patch Set 3: -Verified

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-watson/1039/ (3/3)

-------------------------------------
author: Hugo Blankenship
date: 2016-08-30 15:36:52.452000000

Patch Set 3: Verified+1

Build Successful 

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-watson/931/ : SUCCESS

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-clang_analyzer-watson/770/ : SUCCESS

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-watson/1039/ : SUCCESS

-------------------------------------
author: Tate Garrett
date: 2016-08-30 16:53:55.282000000

Change has been successfully cherry-picked as 8734958cbfc7a326570ef415468934f1ba5ed5d4 by Ashlee Kent

-------------------------------------
