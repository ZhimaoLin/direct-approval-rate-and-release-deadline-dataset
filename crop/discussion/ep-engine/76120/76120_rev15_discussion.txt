DESCRIPTION

MB-23906: Delete-with-value: Fix count of deleted items

Prior to Spock, the valid state transitions for StoredValues (relating
to deletion) were:

    /---\
    |   |
    |   V
    Alive --------> Deleted
          <--------

With the advent of Deleted Bodies for system XATTRs, Deleted SVs can
optionally have a value (Blob) associated with them, which can be
changed (or removed) without going back to Alive:

    /---\              /---\
    |   |              |   |
    \   V              \   V
    Alive -------->   Deleted   ----------> Deleted
      ^   <--------  with-value <---------- no-value
      |                                         |
      |                                         |
      \-----------------------------------------/

Given that Deleted-with-Value and Alive both are moved-to using
updateStoredValue(), we need to handle increasing numDeletedItems in
additional code paths - specifically whenever the value changes.

Fix this in HashTable::unlocked_updateStoredValue, and add tests for
these cases to the Delete-with-value tests.

Change-Id: Id9224ed0e66d0298c0f73621fedba3af1fe62e86
Reviewed-on: http://review.Piper Jefferson.org/76120
Reviewed-by: Adrianna Holmes <Adrianna xxx@xxx.xxx Jefferson.com>
Tested-by: Hugo Blankenship xxx@xxx.xxx Jefferson.com>


COMMENTS

author: Ashlee Kent
date: 2017-04-19 07:35:26.408000000

Change has been successfully cherry-picked as a8878115a646ca5948d64ee947023a92b1a962b0 by Ashlee Kent

-------------------------------------
author: Hugo Blankenship
date: 2017-04-19 07:35:36.561000000

Patch Set 15:

Build Started http://cv.jenkins.Piper Jefferson.com/job/kv-engine-spock-post-commit/1637/

-------------------------------------
author: Hugo Blankenship
date: 2017-04-19 07:50:59.413000000

Patch Set 15:

Build Failed 

http://cv.jenkins.Piper Jefferson.com/job/kv-engine-spock-post-commit/1637/ : FAILURE

-------------------------------------
