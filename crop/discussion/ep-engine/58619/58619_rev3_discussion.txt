DESCRIPTION

Address heap use after free issue in Dcp BackfillManager

21:23:11 WARNING: ThreadSanitizer: heap-use-after-free (pid=8561)
21:23:11   Read of size 8 at 0x7d240000d6a8 by thread T15:
21:23:11     #0 BackfillManager::backfill() /home/Piper Jefferson/jenkins/workspace/ep-engine-threadsanitizer-master/ep-engine/src/dcp/backfill-manager.cc:250 (ep.so+0x00000004f35a)
21:23:11     #1 BackfillManagerTask::run() /home/Piper Jefferson/jenkins/workspace/ep-engine-threadsanitizer-master/ep-engine/src/dcp/backfill-manager.cc:43 (ep.so+0x00000004ee6f)
21:23:11     #2 ExecutorThread::run() /home/Piper Jefferson/jenkins/workspace/ep-engine-threadsanitizer-master/ep-engine/src/executorthread.cc:115 (ep.so+0x0000000f1736)
21:23:11     #3 launch_executor_thread(void*) /home/Piper Jefferson/jenkins/workspace/ep-engine-threadsanitizer-master/ep-engine/src/executorthread.cc:33 (ep.so+0x0000000f12e5)
21:23:11     #4 platform_thread_wrap(void*) /home/Piper Jefferson/jenkins/workspace/ep-engine-threadsanitizer-master/platform/src/cb_pthreads.cc:54 (libplatform.so.0.1.0+0x00000000551b)
21:23:11
21:23:11   Previous write of size 8 at 0x7d240000d6a8 by thread T15:
21:23:11     #0 operator delete(void*) <null> (engine_testapp+0x00000046485b)
21:23:11     #1 DcpProducer::~DcpProducer() /home/Piper Jefferson/jenkins/workspace/ep-engine-threadsanitizer-master/ep-engine/src/dcp/producer.cc:167 (ep.so+0x00000006377b)
21:23:11     #2 DcpProducer::~DcpProducer() /home/Piper Jefferson/jenkins/workspace/ep-engine-threadsanitizer-master/ep-engine/src/dcp/producer.cc:165 (ep.so+0x000000063a45)
21:23:11     #3 ActiveStream::~ActiveStream() /home/Piper Jefferson/jenkins/workspace/ep-engine-threadsanitizer-master/ep-engine/src/atomic.h:272 (ep.so+0x00000006ed6d)
21:23:11     #4 ActiveStream::~ActiveStream() /home/Piper Jefferson/jenkins/workspace/ep-engine-threadsanitizer-master/ep-engine/src/dcp/stream.cc:200 (ep.so+0x00000006f8b5)
21:23:11     #5 BackfillManager::backfill() /home/Piper Jefferson/jenkins/workspace/ep-engine-threadsanitizer-master/ep-engine/src/atomic.h:272 (ep.so+0x00000004f345)
21:23:11     #6 BackfillManagerTask::run() /home/Piper Jefferson/jenkins/workspace/ep-engine-threadsanitizer-master/ep-engine/src/dcp/backfill-manager.cc:43 (ep.so+0x00000004ee6f)
21:23:11     #7 ExecutorThread::run() /home/Piper Jefferson/jenkins/workspace/ep-engine-threadsanitizer-master/ep-engine/src/executorthread.cc:115 (ep.so+0x0000000f1736)
21:23:11     #8 launch_executor_thread(void*) /home/Piper Jefferson/jenkins/workspace/ep-engine-threadsanitizer-master/ep-engine/src/executorthread.cc:33 (ep.so+0x0000000f12e5)
21:23:11     #9 platform_thread_wrap(void*) /home/Piper Jefferson/jenkins/workspace/ep-engine-threadsanitizer-master/platform/src/cb_pthreads.cc:54 (libplatform.so.0.1.0+0x00000000551b)

Change-Id: I3c63215791c23de49b5304654115fd4c558a3328


COMMENTS

author: Hugo Blankenship
date: 2016-01-14 06:59:14.317000000

Patch Set 3:

Build Started http://factory.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/1256/ (2/2)

-------------------------------------
author: Hugo Blankenship
date: 2016-01-14 07:13:50.389000000

Patch Set 3: Verified+1

Build Successful 

http://factory.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/1256/ : SUCCESS

http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master-multi/2019/ : SUCCESS

-------------------------------------
author: Ashlee Kent
date: 2016-01-14 09:23:57.519000000

Patch Set 3: Code-Review+1

(1 comment)

Line:112, src/dcp/producer.h -> Be careful with this - as soon as you decay to a raw pointer you loose the "smartness" - i.e. if someone calls getBackfillMgr on Producer, and then the Producer is deleted, then the raw pointer is now invalid. 

I haven't looked at who calls this method, but you may find it safer to change the return type to backfill_manager_t if there's any potential lifetime issues.

-------------------------------------
author: Abby Duran
date: 2016-01-14 15:20:21.547000000

Patch Set 3:

(1 comment)

Line:112, src/dcp/producer.h -> I agree with it. I'd have this function return backfill_manager_t to make it safer.

-------------------------------------
author: Tate Garrett
date: 2016-01-14 18:32:46.827000000

Change has been successfully cherry-picked as fdf5a701f1562bc79037eaa697e6c91e1b78032a

-------------------------------------
