DESCRIPTION

MB-20735: Fix incorrect waketime for executor threads

When a thread is done with a task from a particular queue,
it calls doneWork() which was resetting its current Queue type
resulting in subsequent reschedule to pick infinity as
earliest thread waketime and end up sleeping longer when the
readyQueue is empty.
Simplify the reschedule logic as part of this fix.
+Add unit test for validation.

Change-Id: Ifdad1d21e624982460046393d4c377247da90735


COMMENTS

author: Ellie Kidd
date: 2016-08-30 18:04:46.621000000

Uploaded patch set 5.

-------------------------------------
author: Hugo Blankenship
date: 2016-08-30 18:04:56.795000000

Patch Set 5:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-addresssanitizer-master/24/ (1/4)

-------------------------------------
author: Hugo Blankenship
date: 2016-08-30 18:04:56.938000000

Patch Set 5:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master/1219/ (2/4)

-------------------------------------
author: Hugo Blankenship
date: 2016-08-30 18:04:57.074000000

Patch Set 5:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/1129/ (3/4)

-------------------------------------
author: Hugo Blankenship
date: 2016-08-30 18:04:57.214000000

Patch Set 5:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-clang_analyzer-master/961/ (4/4)

-------------------------------------
author: Hugo Blankenship
date: 2016-08-30 18:32:58.490000000

Patch Set 5: Verified-1

Build Failed 

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-addresssanitizer-master/24/ : ABORTED

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/1129/ : FAILURE

Failure of a CTest test  ( http://cv.jenkins.Piper Jefferson.com//job/ep-engine-threadsanitizer-master/1129/ )

ThreadSanitizer issue: data race /home/Piper Jefferson/jenkins/workspace/ep-engine-threadsanitizer-master/ep-engine/src/tasks.cc:36 FlusherTask::run()  ( http://cv.jenkins.couchbase.com//job/ep-engine-threadsanitizer-master/1129/ )

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-clang_analyzer-master/961/ : SUCCESS

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master/1219/ : SUCCESS

-------------------------------------
author: Jim WNathalie Landryer
date: 2016-08-31 08:31:15.293000000

Patch Set 5:

> (2 comments)

That's true, I can see (after reading again :) ) that if we enter TaskQueue::_doSleep and attempt to sleep with waketime of -1, we will be bounded to MIN_SLEEP_TIME. So the test looks good in its current form.

So if with this bug, the worst a delay could of been is 2seconds, does it address the problems seen in the FDB performance MB?

-------------------------------------
author: Jim WNathalie Landryer
date: 2016-08-31 08:31:51.662000000

Patch Set 5: Code-Review+2

-------------------------------------
author: Jim WNathalie Landryer
date: 2016-08-31 10:05:43.778000000

Patch Set 5:

I think Will is fixing phosphor so that the TSAN problem you see should go away soon...

-------------------------------------
author: Ellie Kidd
date: 2016-08-31 17:52:35.545000000

Patch Set 5:

Thanks Jim, Will

-------------------------------------
author: Hugo Blankenship
date: 2016-08-31 19:38:16.114000000

Patch Set 5: -Verified

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/1142/ (4/4)

-------------------------------------
author: Hugo Blankenship
date: 2016-08-31 19:38:24.902000000

Patch Set 5:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-addresssanitizer-master/36/ (4/4)

-------------------------------------
author: Hugo Blankenship
date: 2016-08-31 19:48:30.417000000

Patch Set 5: Verified+1

Build Successful 

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-clang_analyzer-master/961/ : SUCCESS

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master/1219/ : SUCCESS

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-addresssanitizer-master/36/ : SUCCESS

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/1142/ : SUCCESS

-------------------------------------
author: Tate Garrett
date: 2016-09-01 00:42:58.475000000

Change has been successfully cherry-picked as 63e4ba7ae23a0d34127c8c408d00f72ea2e9143f by Abby Duran

-------------------------------------
