DESCRIPTION

MB-17631: Fix sporadic ep-engine unit test failures

Fix resolves sporadic unit test failures observed on CV job runs.
This particular commit fixes several failures in following ep-engine
testcases:
- test_est_vb_move
- test_tap_takeover

Change-Id: Ibe20b471a12afea559b319671599076b0f2a0876


COMMENTS

author: Cora Mccarty
date: 2016-02-03 21:16:31.876000000

Uploaded patch set 2.

-------------------------------------
author: Hugo Blankenship
date: 2016-02-03 21:16:39.454000000

Patch Set 2:

Build Started http://factory.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/1566/ (2/2)

-------------------------------------
author: Hugo Blankenship
date: 2016-02-03 21:53:40.618000000

Patch Set 2: Verified-1

Build Failed 

http://factory.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/1566/ : FAILURE

http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master-multi/2344/ : SUCCESS

-------------------------------------
author: Ashlee Kent
date: 2016-02-04 09:36:10.416000000

Patch Set 2: Code-Review-2

(2 comments)

Line:2294, tests/ep_testsuite.cc -> Again, I think this is just attempting to address the symptoms of the problem. 

Could you explain what you believe the issue is here, and why we should ever see ep_total_persisted greater than zero at the start of a test?

Line:7696, tests/ep_testsuite.cc -> If you look at the test_setup() function which is called prior to this test (see the array at the bottom of this file) you'll see that test_setup() will cause vBucket zero to be set active, which /should/ cause the file to be created. 

Given that the test sometimes passes, this code you have here looks to just be attempting to treat the symptom, not the cause. 

I suggest you analyse the behaviour of the test (say use strace / dtruss or similar to examine what file operations are occurring). At I guess I'd say we have multiple tests trying to access the same set of files.

-------------------------------------
author: Tate Garrett
date: 2016-03-12 00:18:40.200000000

Change has been successfully cherry-picked as b4c873b53a1fe57c72651bcf6d9a12f16894aec4

-------------------------------------
