DESCRIPTION

MB-20943: Set state to dead when deleting vbucket

When executing the VBucketMemoryDeletionTask the vbucket state is
unchanged.  notifyAllPendingConnsFailed is called in the run
function of VBucketMemoryDeletionTask.  This inturn calls fireAllOps,
which ensures all pending ops are cleared if the vbucket is in an
active state.

However if the vbucket is in a pending state is does nothing and
therefore the pending operations remain.  This results in connections
not being closed down.

The solution provided is to set the vbcuekt state to dead before
calling notifyAllPendingConnsFailed.

A corresponding test has been added, which without the fix will hang.

Change-Id: I09cd4597b26576dd4b99d26f3a60c031e1b5f41d


COMMENTS

author: Kymani Ramirez
date: 2016-09-21 14:19:54.658000000

Uploaded patch set 5.

-------------------------------------
author: Hugo Blankenship
date: 2016-09-21 14:20:02.794000000

Patch Set 5:

Branch restricted. PLEASE READ this URL: 

http://server.jenkins.Piper Jefferson.com/job/restricted-branch-check/24067/artifact/restricted.html : FAILURE

-------------------------------------
author: Hugo Blankenship
date: 2016-09-21 14:20:03.621000000

Patch Set 5:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-4.5.1/6/ (1/3)

-------------------------------------
author: Hugo Blankenship
date: 2016-09-21 14:20:03.768000000

Patch Set 5:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-clang_analyzer-4.5.1/6/ (2/3)

-------------------------------------
author: Hugo Blankenship
date: 2016-09-21 14:20:03.912000000

Patch Set 5:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-4.5.1/6/ (3/3)

-------------------------------------
author: Ashlee Kent
date: 2016-09-21 14:25:20.218000000

Patch Set 5:

(2 comments)

Line:6480, tests/ep_testsuite.cc -> We don't really remove the ops - they get completed (the client gets a response). maybe change to "complete" ?

Line:1493, src/ep.cc -> I believe this should be inside the vbsetMutex. Suggest you move it to just before DcpConnMap().vbucketStateChanged().

-------------------------------------
author: Hugo Blankenship
date: 2016-09-21 14:27:54.257000000

Patch Set 5: Verified+1

Build Successful 

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-4.5.1/6/ : SUCCESS

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-clang_analyzer-4.5.1/6/ : SUCCESS

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-4.5.1/6/ : SUCCESS

-------------------------------------
author: Kymani Ramirez
date: 2016-09-21 14:32:58.003000000

Patch Set 5:

(2 comments)

Line:6480, tests/ep_testsuite.cc -> Done

Line:1493, src/ep.cc -> Done

-------------------------------------
author: Tate Garrett
date: 2016-09-21 16:29:44.921000000

Change has been successfully cherry-picked as e9a655b49393e1302bf75aa759b11969545c986a by Ashlee Kent

-------------------------------------
