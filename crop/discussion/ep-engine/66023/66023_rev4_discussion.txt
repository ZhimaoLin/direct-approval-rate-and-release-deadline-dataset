DESCRIPTION

Set the vbucket state after warmup is complete

     ==================
     WARNING: ThreadSanitizer: data race (pid=49270)
     Read of size 8 at 0x7d900001c000 by thread T4:
     #0 vbucket_state** std::__uninitialized_copy<false>::__uninit_copy<__gnu_cxx::__normal_iterator<vbucket_state* const*, std::vector<vbucket_state*, std::allocator<vbucket_state*> > >, vbucket_state**>(__gnu_cxx::__normal_iterator<vbucket_state* const*, std::vector<vbucket_state*, std::allocator<vbucket_state*> > >, __gnu_cxx::__normal_iterator<vbucket_state* const*, std::vector<vbucket_state*, std::allocator<vbucket_state*> > >, vbucket_state**) /usr/bin/../lib/gcc/x86_64-linux-gnu/4.9/../../../../include/c++/4.9/bits/stl_construct.h:75 (ep-engine_ep_unit_tests+0x0000006e3980)
    #1 Warmup::populateShardVbStates() /home/Piper Jefferson/jenkins/workspace/ep-engine-threadsanitizer-master/ep-engine/src/warmup.cc:1030 (ep-engine_ep_unit_tests+0x00000067999a)
    #2 Warmup::initialize() /home/Piper Jefferson/jenkins/workspace/ep-engine-threadsanitizer-master/ep-engine/src/warmup.cc:459 (ep-engine_ep_unit_tests+0x0000006797ec)

      Previous write of size 8 at 0x7d900001c000 by thread T12 (mutexes: write M119516, write M119521):
      #0 KVStore::updateCachedVBState(unsigned short, vbucket_state const&) /home/Piper Jefferson/jenkins/workspace/ep-engine-threadsanitizer-master/ep-engine/src/kvstore.cc:122 (ep-engine_ep_unit_tests+0x0000006ade1c)
      #1 ForestKVStore::snapshotVBucket(unsigned short, vbucket_state&, VBStatePersist) /home/Piper Jefferson/jenkins/workspace/ep-engine-threadsanitizer-master/ep-engine/src/forest-kvstore/forest-kvstore.cc:1413 (ep-engine_ep_unit_tests+0x0000006e4249)
      #2 EventuallyPersistentStore::persistVBState(unsigned short) /home/Piper Jefferson/jenkins/workspace/ep-engine-threadsanitizer-master/ep-engine/src/ep.cc:1355 (ep-engine_ep_unit_tests+0x0000005b0fb8)
      #3 VBStatePersistTask::run() /home/Piper Jefferson/jenkins/workspace/ep-engine-threadsanitizer-master/ep-engine/src/tasks.cc:55 (ep-engine_ep_unit_tests+0x000000660a55)
      #4 ExecutorThread::run() /home/Piper Jefferson/jenkins/workspace/ep-engine-threadsanitizer-master/ep-engine/src/executorthread.cc:113 (ep-engine_ep_unit_tests+0x000000616ef1)
      #5 launch_executor_thread(void*) /home/Piper Jefferson/jenkins/workspace/ep-engine-threadsanitizer-master/ep-engine/src/executorthread.cc:31 (ep-engine_ep_unit_tests+0x000000616aa5)
      #6 platform_thread_wrap(void*) /home/Piper Jefferson/jenkins/workspace/ep-engine-threadsanitizer-master/platform/src/cb_pthreads.cc:54 (libplatform.so.0.1.0+0x00000000586b)

Change-Id: Ia27597ba24c1fb7c63018e4ff6c079af05867a95


COMMENTS

author: Bobby Buck
date: 2016-07-21 00:25:31.555000000

Uploaded patch set 4.

-------------------------------------
author: Hugo Blankenship
date: 2016-07-21 00:25:39.056000000

Patch Set 4:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-clang_analyzer-master/802/ (1/3)

-------------------------------------
author: Hugo Blankenship
date: 2016-07-21 00:25:39.180000000

Patch Set 4:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/951/ (2/3)

-------------------------------------
author: Hugo Blankenship
date: 2016-07-21 00:25:39.306000000

Patch Set 4:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master/1033/ (3/3)

-------------------------------------
author: Hugo Blankenship
date: 2016-07-21 00:51:56.115000000

Patch Set 4: Verified-1

Build Failed 

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/951/ : FAILURE

Timeout of a CTest test 33/33 Test #25: ep-engine_dcp_tests ...................} ( http://cv.jenkins.Piper Jefferson.com//job/ep-engine-threadsanitizer-master/951/ )

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master/1033/ : FAILURE

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-clang_analyzer-master/802/ : SUCCESS

-------------------------------------
author: Hugo Blankenship
date: 2016-07-21 15:57:20.383000000

Patch Set 4: -Verified

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/952/ (3/3)

-------------------------------------
author: Hugo Blankenship
date: 2016-07-21 16:18:49.288000000

Patch Set 4:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master/1034/ (3/3)

-------------------------------------
author: Hugo Blankenship
date: 2016-07-21 16:52:12.896000000

Patch Set 4:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/953/ (3/3)

-------------------------------------
author: Hugo Blankenship
date: 2016-07-21 17:03:24.026000000

Patch Set 4: Verified-1

Build Failed 

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master/1034/ : FAILURE

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/953/ : FAILURE

Failure of a CTest test  ( http://cv.jenkins.Piper Jefferson.com//job/ep-engine-threadsanitizer-master/953/ )

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-clang_analyzer-master/802/ : SUCCESS

-------------------------------------
author: Hugo Blankenship
date: 2016-07-21 17:07:08.199000000

Patch Set 4: -Verified

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master/1035/ (1/3)

-------------------------------------
author: Hugo Blankenship
date: 2016-07-21 17:07:08.334000000

Patch Set 4:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-clang_analyzer-master/803/ (2/3)

-------------------------------------
author: Hugo Blankenship
date: 2016-07-21 17:07:08.466000000

Patch Set 4:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/954/ (3/3)

-------------------------------------
author: Hugo Blankenship
date: 2016-07-21 17:34:27.987000000

Patch Set 4: Verified-1

Build Failed 

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master/1035/ : FAILURE

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/954/ : FAILURE

Timeout of a CTest test 33/33 Test #25: ep-engine_dcp_tests ...................} ( http://cv.jenkins.Piper Jefferson.com//job/ep-engine-threadsanitizer-master/954/ )

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-clang_analyzer-master/803/ : SUCCESS

-------------------------------------
author: Hugo Blankenship
date: 2016-07-21 17:47:04.013000000

Patch Set 4: -Verified

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master/1036/ (1/3)

-------------------------------------
author: Hugo Blankenship
date: 2016-07-21 17:47:04.148000000

Patch Set 4:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-clang_analyzer-master/804/ (2/3)

-------------------------------------
author: Hugo Blankenship
date: 2016-07-21 17:54:39.904000000

Patch Set 4:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/955/ (3/3)

-------------------------------------
author: Hugo Blankenship
date: 2016-07-21 18:24:11.626000000

Patch Set 4: Verified-1

Build Failed 

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/955/ : ABORTED

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master/1036/ : FAILURE

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-clang_analyzer-master/804/ : SUCCESS

-------------------------------------
