DESCRIPTION

MB-17653 (2/2): Calculate ActiveStream::getItemsRemaining() correctly

Fix the calculation of getItemsRemaining() to actually return how many
items which are still to be sent for the given stream.

The previous code was based around sequence numbers, which doesn't
take into account de-duplicaiton of items by the CheckpointManager.

New algorithm counts the number of (non-meta) items still in
Checkpoints (which the Stream's cursor hasn't advanced to yet), plus
the number of non-meta items in the Streams' ready queue.

Note this does require us to take a lock on the CheckpointManager (for
getNumItemsForCursor); I have yet to measure if this has any
performance impact.

Change-Id: I9e4eaeafa4e8d71eff881d011c31f61a22794a92


COMMENTS

author: Ashlee Kent
date: 2016-02-18 18:34:15.732000000

Uploaded patch set 4: Patch Set 3 was rebased.

-------------------------------------
author: Ashlee Kent
date: 2016-02-18 18:46:15.323000000

Patch Set 4: -Code-Review

Verified that a full-stack test behaves as expected. see MB update for details.

-------------------------------------
author: Hugo Blankenship
date: 2016-02-18 18:51:50.318000000

Patch Set 4:

Build Started http://factory.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/1841/ (2/2)

-------------------------------------
author: Hugo Blankenship
date: 2016-02-18 19:18:28.140000000

Patch Set 4: Verified-1

Build Failed 

http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master-multi/2586/ : FAILURE

http://factory.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/1841/ : SUCCESS

-------------------------------------
author: Hugo Blankenship
date: 2016-02-18 21:00:05.619000000

Patch Set 4: -Verified

Build Started http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master-multi/2596/ (2/2)

-------------------------------------
author: Hugo Blankenship
date: 2016-02-18 21:11:36.346000000

Patch Set 4: Verified-1

Build Failed 

http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master-multi/2596/ : FAILURE

http://factory.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/1841/ : SUCCESS

-------------------------------------
author: Hugo Blankenship
date: 2016-02-18 21:14:24.895000000

Patch Set 4: -Verified

Build Started http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master-multi/2598/ (2/2)

-------------------------------------
author: Hugo Blankenship
date: 2016-02-18 21:30:51.351000000

Patch Set 4: Verified-1

Build Failed 

http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master-multi/2598/ : FAILURE

http://factory.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/1841/ : SUCCESS

-------------------------------------
author: Emerson Nolan
date: 2016-02-19 00:04:04.066000000

Patch Set 4: Code-Review+2

-------------------------------------
author: Emerson Nolan
date: 2016-02-19 00:05:40.072000000

Patch Set 4: -Code-Review

stream_test leaks memory:

http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master-multi/2598/label_exp=sherlocker-ubuntu12.04/

-------------------------------------
author: Ashlee Kent
date: 2016-02-22 15:51:52.487000000

Patch Set 5: Patch Set 4 was rebased

-------------------------------------
author: Tate Garrett
date: 2016-02-24 17:41:50.838000000

Change has been successfully cherry-picked as 45d755a2a23bfe2acff0eea5392efe9f8c6d6faf

-------------------------------------
