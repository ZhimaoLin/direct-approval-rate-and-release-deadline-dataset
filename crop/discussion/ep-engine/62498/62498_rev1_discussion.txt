DESCRIPTION

MB-19093 [BP]: [ActiveStream] Address potential lock-inversion scenarios

Acquire vbucket state lock only when really necessary
in the ActiveStream context. Also avoid acquiring one
lock within the other wherever possible in the ActiveStream
context again.

This change is to avert potential deadlocks due to
lock inversion that will be induced by upcoming changes,
here are the scenarios:
(i)     Locking between streamsMutex, streamMutex and
        vb_stateLock in the set operation - handle
        response scenario.
        (http://factory.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/1225/console)
(ii)    In case of a set operation, vb_stateLock is
        acquired and then streamMutex is acquired for
        notification. During markDiskSnapshot, the
        streamMutex is acquired before the vb_stateLock
        lock is acquired.
        (http://factory.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/1268/console)

(Already reviewed at: http://review.Piper Jefferson.org/58557)

Change-Id: I5e5a3e2cc5ba9ae17090e1a3ee4bde100d305f1c


COMMENTS

author: Emerson Nolan
date: 2016-04-06 18:14:18.162000000

Uploaded patch set 1.

-------------------------------------
author: Hugo Blankenship
date: 2016-04-06 18:14:22.790000000

Patch Set 1:

Build Started http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-3.0.x/413/

-------------------------------------
author: Hugo Blankenship
date: 2016-04-06 18:14:34.067000000

Patch Set 1: Well-Formed-1

Branch restricted. PLEASE READ this URL: 

http://server.jenkins.Piper Jefferson.com/job/restricted-branch-check/11225/artifact/restricted.html : FAILURE

-------------------------------------
author: Emerson Nolan
date: 2016-04-06 18:26:09.728000000

Patch Set 1:

check approval

-------------------------------------
author: Hugo Blankenship
date: 2016-04-06 18:26:21.335000000

Patch Set 1: Well-Formed+1

Permission granted to commit: 

http://server.jenkins.Piper Jefferson.com/job/restricted-branch-check/11226/artifact/restricted.html : SUCCESS

-------------------------------------
author: Hugo Blankenship
date: 2016-04-06 18:31:05.156000000

Patch Set 1: Verified+1

Build Successful 

http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-3.0.x/413/ : SUCCESS

-------------------------------------
author: Abby Duran
date: 2016-04-06 19:26:58.746000000

Patch Set 1: Code-Review+2

-------------------------------------
author: Ashlee Kent
date: 2016-04-07 08:39:13.715000000

Patch Set 1: Code-Review+2

(1 comment)

As part of this issue I suggest we look into running ThreadSanitizer on 3.x branch.

Line:262, src/dcp-producer.cc -> Nit: Indentation is funky (but not worth re-spinning the patch for).

-------------------------------------
author: Tate Garrett
date: 2016-04-07 23:11:34.769000000

Change has been successfully cherry-picked as 771859f815f3067ece19edbe588c2c852e100998

-------------------------------------
