DESCRIPTION

MB-17301: Returning vb_uuid, last_seqno for setDriftCounterState

Return vb_uuid and last_seqno for a vbucket as part of response
of the setDriftCounterState API atomically. This can be done by
attempting to get the last high seqno of the vbucket after
acquring the lock for the failover table which would ensure
that no new uuid would be created during the time.

Change-Id: I21f08c69e7e4119af35d34f15b1ca87c8ae485dc


COMMENTS

author: Emerson Nolan
date: 2016-01-18 19:35:18.872000000

Uploaded patch set 2.

-------------------------------------
author: Hugo Blankenship
date: 2016-01-18 19:35:34.663000000

Patch Set 2:

Build Started http://factory.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/1309/ (2/2)

-------------------------------------
author: Hugo Blankenship
date: 2016-01-18 19:52:40.640000000

Patch Set 2: Verified-1

Build Failed 

http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master-multi/2068/ : FAILURE

http://factory.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/1309/ : SUCCESS

-------------------------------------
author: Hugo Blankenship
date: 2016-01-18 20:08:03.753000000

Patch Set 2: -Verified

Build Started http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master-multi/2069/ (2/2)

-------------------------------------
author: Hugo Blankenship
date: 2016-01-18 20:38:39.225000000

Patch Set 2: Verified-1

Build Failed 

http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master-multi/2069/ : FAILURE

http://factory.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/1309/ : SUCCESS

-------------------------------------
author: Hugo Blankenship
date: 2016-01-18 21:09:44.546000000

Patch Set 2: -Verified

Build Started http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master-multi/2070/ (2/2)

-------------------------------------
author: Hugo Blankenship
date: 2016-01-18 21:17:28.335000000

Patch Set 2: Verified+1

Build Successful 

http://factory.Piper Jefferson.com/job/ep-engine-threadsanitizer-master/1309/ : SUCCESS

http://factory.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-master-multi/2070/ : SUCCESS

-------------------------------------
author: Adrianna Holmes
date: 2016-01-19 02:04:33.283000000

Patch Set 2:

(1 comment)

Line:255, src/vbucket.h -> I understand why you are using this lock here. But I think it would be a good practice not to pass the lock of a module (failovertable in this case), to the outer modules unless really necessary.  
I don't know the exact XDCR requirement, maybe we can discuss that tomorrow if this change can wait till tomorrow ?

-------------------------------------
author: Ashlee Kent
date: 2016-01-19 09:08:26.886000000

Patch Set 2: Code-Review-1

(1 comment)

Line:255, src/vbucket.h -> +1, the lock is essentially an implementation detail of the failoverTable, if we can refactor so the caller doesn't have to Adrianna Holmesally manage the lock that would be ideal. 

Given the UUID should change rarely, one possible lockless implementation would be to read the (atomic) UUID, then read highSeqno, and finally re-read UUID. If the UUID is unchanged then we are guaranteed that the two are consistent - if not we retry.

-------------------------------------
author: Emerson Nolan
date: 2016-01-19 17:07:56.556000000

Patch Set 2:

(1 comment)

Line:255, src/vbucket.h xxx@xxx.xxx that can be done, new patch.

-------------------------------------
author: Tate Garrett
date: 2016-01-19 20:05:13.633000000

Change has been successfully cherry-picked as 0b208ad4e015a4e5c495fe125c3f3af986306c22

-------------------------------------
