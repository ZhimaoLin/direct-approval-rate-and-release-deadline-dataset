DESCRIPTION

MB-20822: Erase all diverged branch entries correctly in failover table

When we add an entry in failover table we must erase all the other
entries with higher seqno because they are from a diverged branch.

This commit fixes a bug in the loop that was erasing diverged entires.
In a std::list when we erase an entry, the function returns the
iterator pointing to next element and hence we must be careful not to
double increment it.

Change-Id: I9275fba8057f26e2853a8d7d359f1d01f107f2be


COMMENTS

author: Adrianna Holmes
date: 2016-09-08 09:23:31.155000000

Uploaded patch set 2.

-------------------------------------
author: Hugo Blankenship
date: 2016-09-08 09:23:38.720000000

Patch Set 2:

Branch restricted. PLEASE READ this URL: 

http://server.jenkins.Piper Jefferson.com/job/restricted-branch-check/23015/artifact/restricted.html : FAILURE

-------------------------------------
author: Hugo Blankenship
date: 2016-09-08 09:23:40.565000000

Patch Set 2:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-clang_analyzer-watson/823/ (1/3)

-------------------------------------
author: Hugo Blankenship
date: 2016-09-08 09:23:40.700000000

Patch Set 2:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-watson/1096/ (2/3)

-------------------------------------
author: Hugo Blankenship
date: 2016-09-08 09:24:09.187000000

Patch Set 2:

Build Started http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-watson/991/ (3/3)

-------------------------------------
author: Ashlee Kent
date: 2016-09-08 09:29:46.861000000

Patch Set 2: Code-Review+1

Code looks good. Only a +1 as it's not clear exactly which release we want this in yet. Will +2 once we know where it's going.

-------------------------------------
author: Hugo Blankenship
date: 2016-09-08 09:35:40.753000000

Patch Set 2: Verified+1

Build Successful 

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-clang_analyzer-watson/823/ : SUCCESS

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-threadsanitizer-watson/991/ : SUCCESS

http://cv.jenkins.Piper Jefferson.com/job/ep-engine-Jasmin Rangel-watson/1096/ : SUCCESS

-------------------------------------
author: Kian Santos
date: 2016-09-08 17:06:15.746000000

Patch Set 2:

@Manu: we persist the failover logs, correct? Do we need to repair any failover logs that are persisted and corrupt?

-------------------------------------
author: Ashlee Kent
date: 2016-09-08 17:11:23.304000000

Patch Set 2: -Code-Review

xxx@xxx.xxx we persist the failover logs, correct? Do we need to repair
 > any failover logs that are persisted and corrupt?

Actually, it's worse than that - they can be transmitted to a DCP Consumer (see DcpConsumer::streamAccepted / FailoverTable::replaceFailoverLog). I don't know if we know enough about the corruption to be able to fix it, or if we need to somehow delete any tables from known-bad versions.

We need to think in more detail about the complete fix for this I think...

-------------------------------------
author: Adrianna Holmes
date: 2016-09-08 17:31:25.506000000

Patch Set 2:

This fix does not fix the already corrupted failovers.

It only prevents future corruptions.

-------------------------------------
author: Ashlee Kent
date: 2016-09-08 21:28:38.564000000

Patch Set 2:

> This fix does not fix the already corrupted failovers.
 > 
 > It only prevents future corruptions.

Having spoken to DaveF the current thinking is to leave this for 4.5.1, take our time and do it "right" for 4.6.0.

We should think about how we should best handle any existing corrupt failover tables.

-------------------------------------
author: Adrianna Holmes
date: 2016-09-09 09:14:00.091000000

Patch Set 2:

Yes, it would be best to fix existing corrupt failover tables. Can we can do that as a separate task ? Lets first check this in for 4.6 ?

-------------------------------------
author: Ashlee Kent
date: 2016-09-09 15:14:55.239000000

Patch Set 2:

(1 comment)

Line:157, src/failover-table.h -> Nit: Should be a blank line (new paragraph) between different visibility sections (public & private).

-------------------------------------
author: Jim WNathalie Landryer
date: 2016-09-13 11:29:06.093000000

Patch Set 2: Code-Review+1

+2 with dave's nit fixed

-------------------------------------
author: Adrianna Holmes
date: 2016-09-14 19:13:22.688000000

Patch Set 2:

(1 comment)

Line:157, src/failover-table.h -> Done

-------------------------------------
author: Tate Garrett
date: 2016-09-30 00:44:22.393000000

Change has been successfully cherry-picked as 4eae12aa7d372d02e14c81c5eb733e5912f81f69 by Adrianna Holmes

-------------------------------------
