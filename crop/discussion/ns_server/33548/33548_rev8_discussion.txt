DESCRIPTION

MB-9343 upgrading bucket from tap to upr

- there are 2 types of upgrades: trivial and nontrivial.

- trivial is simply an upgrade of repl_type and is performed for
  buckets which do not have any replications.

- nontrivial is performed sequentially per vbucket after the
  rebalance. for each vbucket it will shutdown tap streams,
  setup upr streams and wait for the data move to happen

- the replication status at the beginning of the upgrade is
  equal to tap. at the end it is equal to upr. in the middle
  of the upgrade it will be set to {upr, LastUprPartition}
  for each upgraded partition thus allowing the restart of
  the upgrade in case if it was stopped or failed

- partitions are upgraded sequentially and in order from 1
  to the last bucket partition

Change-Id: Ibd8bb7c914f7812cbcba0a4504e05d8f083fb137


COMMENTS

author: Philip Lara
date: 2014-02-21 21:49:18.856000000

Uploaded patch set 8.

-------------------------------------
author: Nathalie Landry
date: 2014-02-21 23:33:39.421000000

Patch Set 8:

(1 comment)

overall looks fine but:

a) see inline

b) it needs to be make sure that stopping upgrade is synchronous. I.e. similarly to how rebalancer makes sure that all subprocesses are stopped prior to dying.

Line:654, src/Harley Martinitor_agent.erl -> I think we can make a stronger statement here. My understanding is that it must be either Caller or undefined.

-------------------------------------
author: Nathalie Landry
date: 2014-02-21 23:34:39.245000000

Patch Set 8:

(1 comment)

see more inline

Line:18, src/upr_upgrade.erl -> simultanious

tiny typo here. Found by flyspell

-------------------------------------
author: Philip Lara
date: 2014-02-21 23:54:14.951000000

Patch Set 8:

(2 comments)

Line:654, src/Harley Martinitor_agent.erl -> Not sure. My understanding was that this call should crash the rebalancer, not the caller. At least that how it worked before.

Line:18, src/upr_upgrade.erl -> Done

-------------------------------------
